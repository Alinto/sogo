#!/bin/sh

#
# Note: When adding make options to this script, ensure that the source still
#       compiles without those options! (and just with GNUstep.sh being
#       sourced)
#       We do not want to force people to run configure.
#

# ******************** variables ****************

CFG_ARGS="$0 $1 $2 $3 $4 $5 $6 $7 $8 $9"

ARG_BEQUIET=0
ARG_NOCREATE=0
ARG_PREFIX=""
ARG_GSMAKE=`gnustep-config --variable=GNUSTEP_MAKEFILES 2>/dev/null`
ARG_CFGMAKE="$PWD/config.make"
ARG_WITH_GNUSTEP=1
ARG_WITH_DEBUG=1
ARG_WITH_STRIP=1

DARG_GNUSTEP_SH="$ARG_GSMAKE/GNUstep.sh"
DARG_IS_FHS=1

# detect GNU make, needed at least on *BSD
make -v 2>/dev/null | grep GNU >/dev/null 2>/dev/null
if [ $? -eq 0 ];then
  MAKE=make
else
  MAKE=gmake
fi

NGSTREAMS_DIR="./sope-core/NGStreams"
LINK_SYSLIBDIRS="-L/usr/local/pgsql/lib -L/usr/local/lib -L/usr/lib"

# ******************** usage ********************

usage() {
  cat <<_ACEOF
\`configure' configures a GNUstep-make based sourcetree for installation.

Usage: $0 [OPTION]...

Note: You do not need to configure this source tree, as another option
      just ensure that the GNUstep.sh of your GNUstep make installation
      is properly sourced prior running make.

Configuration:
  -h, --help              display this help and exit
  -q, --quiet, --silent   do not print \`checking...' messages
  -n, --no-create         do not create output files

Installation directories:
  --prefix=PREFIX	  install files in PREFIX [/usr/local]
  --gsmake=PATH           path to gnustep-make tree
  --configmake=PATH       path to the config file being created
  --without-gnustep       do not install in GNUstep tree
  --enable-debug          turn on debugging and compile time warnings
  --enable-strip          turn on stripping of debug symbols

_ACEOF

  exit 0;
}

# ******************** running ********************

printParas() {
  echo "Configuration:"
  if test $ARG_BEQUIET  = 1; then echo "  will be quite.";  fi
  if test $ARG_NOCREATE = 1; then echo "  won't create files"; fi
  if test $DARG_IS_FHS = 1;  then
    echo "  FHS:    install in FHS root"; 
  else
    echo "  FHS:    install in GNUstep tree"; 
  fi

  if test $ARG_WITH_DEBUG = 1; then 
    echo "  debug:  yes";
  else
    echo "  debug:  no";
  fi
  if test $ARG_WITH_STRIP = 1; then 
    echo "  strip:  yes";
  else
    echo "  strip:  no";
  fi
  
  echo "  prefix: $ARG_PREFIX"
  echo "  gstep:  $ARG_GSMAKE"
  echo "  config: $ARG_CFGMAKE"
  echo "  script: $DARG_GNUSTEP_SH"
  echo ""
}

warnOnFHSPrefix() {
  cat <<_ACEOFWARN
Warning: you are configuring for a non standard FHS style prefix.
         prefix: $ARG_PREFIX

Some code in SOPE only looks in /usr and /usr/local for resources and is
therefore incompatible with arbitary install pathes.

If you want to have the flexibility of installation in arbitary pathes just
configure GNUstep-make and source the GNUstep.sh script prior executing tools
to ensure a proper environment.
All SOPE based code is completely relocatable when being used in a GNUstep
environment.

_ACEOFWARN
}

validateGNUstepArgs() {
  # GNUstep make
  if test "x$ARG_GSMAKE" = "x"; then
    if test -f $HOME/OGoRoot/Library/Makefiles/GNUstep.sh; then
      ARG_GSMAKE="$HOME/OGoRoot/Library/Makefiles/"
    elif test -f $HOME/GNUstep/Library/Makefiles/GNUstep.sh; then
      ARG_GSMAKE="$HOME/GNUstep/Library/Makefiles/"
    elif test -f /usr/GNUstep/System/Library/Makefiles/GNUstep.sh; then
      ARG_GSMAKE="/usr/GNUstep/System/Library/Makefiles/"
    elif test -f /usr/share/GNUstep/Makefiles/GNUstep.sh; then
      ARG_GSMAKE="/usr/share/GNUstep/Makefiles/"
    elif test -f $GNUSTEP_MAKEFILES/GNUstep.sh; then
      ARG_GSMAKE="$GNUSTEP_MAKEFILES/"
    else
      echo "error: please specify a GNUstep make tree!"
      exit 1
    fi
    DARG_GNUSTEP_SH="$ARG_GSMAKE/GNUstep.sh"
  elif test -d $ARG_GSMAKE; then
    if test -f $ARG_GSMAKE/GNUstep.sh; then
      DARG_GNUSTEP_SH="$ARG_GSMAKE/GNUstep.sh"
    elif test -f $ARG_GSMAKE/Library/Makefiles/GNUstep.sh; then
      ARG_GSMAKE="$ARG_GSMAKE/Library/Makefiles"
      DARG_GNUSTEP_SH="$ARG_GSMAKE/GNUstep.sh"
    else
      echo "error: specified directory contains no GNUstep.sh: $ARG_GSMAKE"
      exit 1
    fi
  else
    echo "error: specified GNUstep make tree does not exist: $ARG_GSMAKE"
    exit 1
  fi
}

setupAppleArgs() {
  ARG_WITH_STRIP=0
  ARG_WITH_GNUSTEP=1
  
  if test "xLIBRARY_COMBO" != "apple-apple-nil"; then
    if test "xLIBRARY_COMBO" != "apple-apple-apple"; then
      echo "WARNING: detected unusual GNUstep setup: $LIBRARY_COMBO"
      echo ""
    fi
  fi
}

validateArgs() {
  # validate prefix (could be better?)
  case "x$ARG_PREFIX" in
    "x/usr/local"|"x/usr/local/")
        DARG_IS_FHS=1;
	;;
    "x/usr"|"x/usr/")
        DARG_IS_FHS=1;
	;;
    "x$GNUSTEP_USER_ROOT"|"x$GNUSTEP_LOCAL_ROOT"|"x$GNUSTEP_SYSTEM_ROOT")
        DARG_IS_FHS=0;
	ARG_WITH_GNUSTEP=1;
	;;
    "x")
        if test $ARG_WITH_GNUSTEP = 1; then
          DARG_IS_FHS=0;
          ARG_PREFIX="$GNUSTEP_LOCAL_ROOT"
          if test $ARG_BEQUIET != 1; then
	    echo "Note: will install in GNUSTEP_LOCAL_ROOT: $ARG_PREFIX"
	    echo ""
	  fi
        else
          DARG_IS_FHS=1;
          ARG_PREFIX="/usr/local/"
	  echo "Note: will install in default location: $ARG_PREFIX"
	  echo ""
	fi
	;;
    *)
        if test $ARG_WITH_GNUSTEP = 1; then
	  echo "error: specified --with-gnustep, but specified prefix is not"
	  echo "       a GNUstep root: '$ARG_PREFIX'"
	  exit 1
        else
          if test $ARG_BEQUIET != 1; then
	    warnOnFHSPrefix;
          fi
	  DARG_IS_FHS=1;
        fi
	;;
  esac
  
  if test $ARG_WITH_GNUSTEP = 1; then
    if test $DARG_IS_FHS = 1; then
      echo "error: configured for FHS root _and_ GNUstep tree. Choose one!"
      exit 1
    fi
  fi
}

printGNUstepSetup() {
  echo "GNUstep environment:"
  echo "  system: ${GNUSTEP_SYSTEM_ROOT}"
  echo "  local:  ${GNUSTEP_LOCAL_ROOT}"
  echo "  user:   ${GNUSTEP_USER_ROOT}"
  echo "  path:   ${GNUSTEP_PATHLIST}"
  echo "  flat:   ${GNUSTEP_FLATTENED}"
  echo "  arch:   ${GNUSTEP_HOST}"
  echo "  combo:  ${LIBRARY_COMBO}"
  echo ""
}

cfgwrite() {
  echo "$1" >> $ARG_CFGMAKE
}

genConfigMake() {
  # we ignore the following vars also patches by gstep-make:
  #   PATH
  #   DYLD_LIBRARY_PATH
  #   GUILE_LOAD_PATH
  #   CLASSPATH
  
  if test $ARG_BEQUIET != 1; then
    echo "creating: $ARG_CFGMAKE"
  fi
  
  echo "# GNUstep environment configuration" > $ARG_CFGMAKE
  cfgwrite "#   created by: '$CFG_ARGS'"
  cfgwrite ""
  
  cfgwrite "# Note: you can override any option as a 'make' parameter, eg:"
  cfgwrite "#         $MAKE debug=yes"
  cfgwrite ""
  
  #cfgwrite "# print on the cmdline that this file is being used"
  #cfgwrite "all :: "
  #cfgwrite "	@echo Local GNUstep config.make is active"
  #cfgwrite ""

  cfgwrite "SOGO_MAJOR_VERSION=0"
  cfgwrite "SOGO_MINOR_VERSION=9"
  cfgwrite "SOPE_MAJOR_VERSION=4"
  cfgwrite "SOPE_MINOR_VERSION=7"
  
  if test $DARG_IS_FHS = 1; then
    cfgwrite "# configured for FHS install"
    cfgwrite "FHS_INSTALL_ROOT:=$ARG_PREFIX"
    cfgwrite ""
  fi
  
  if test $ARG_WITH_DEBUG = 1; then
    cfgwrite "# configured to produce debugging code";
    cfgwrite "debug:=yes"
  else
    cfgwrite "# configured to produce non-debugging code";
    cfgwrite "debug:=no"
  fi
  cfgwrite ""
  UNAME=`uname`
  if [ "X${UNAME}" = "XLinux" ];then
    UNAME=`uname -p`
    if [ ${UNAME} = x86_64 -o ${UNAME} = sparc64 -o ${UNAME} = ppc64 ];then
      cfgwrite "CGS_LIBDIR_NAME:=lib64"
    else
      cfgwrite "CGS_LIBDIR_NAME:=lib"
    fi
  else
    cfgwrite "CGS_LIBDIR_NAME:=lib"
  fi

  cfgwrite "ifneq (\$(FHS_INSTALL_ROOT),)"
  cfgwrite "CONFIGURE_FHS_INSTALL_LIBDIR:=\$(FHS_INSTALL_ROOT)/\$(CGS_LIBDIR_NAME)/"
#  cfgwrite "CONFIGURE_SYSTEM_LIB_DIR += -L\$(CONFIGURE_FHS_INSTALL_LIBDIR)"
  cfgwrite "endif"
#  cfgwrite "CONFIGURE_SYSTEM_LIB_DIR += -L/usr/\$(CGS_LIBDIR_NAME)/"

  if test $DARG_IS_FHS = 1; then
    cfgwrite "# configured for FHS install"
    cfgwrite "FHS_INSTALL_ROOT:=$ARG_PREFIX"
    cfgwrite ""
    cfgwrite "SOGO_SYSLIBDIR=\${DESTDIR}\${FHS_INSTALL_ROOT}/\${CGS_LIBDIR_NAME}"
    cfgwrite "SOGO_LIBDIR=\${SOGO_SYSLIBDIR}/sogod-\${SOGO_MAJOR_VERSION}.\${SOGO_MINOR_VERSION}"
    cfgwrite "SOPE_LIBDIR=\$(SOGO_SYSLIBDIR)/sope-\${SOPE_MAJOR_VERSION}.\${SOPE_MINOR_VERSION}"
    cfgwrite "SOGO_SYSSHAREDIR=\${DESTDIR}\${FHS_INSTALL_ROOT}/share"
    cfgwrite "SOGO_SHARED=\${SOGO_SYSSHAREDIR}/sogo-\${SOGO_MAJOR_VERSION}.\${SOGO_MINOR_VERSION}"
    cfgwrite "SOPE_SHARED=\${SOGO_SYSSHAREDIR}/sope-\${SOPE_MAJOR_VERSION}.\${SOPE_MINOR_VERSION}"
    cfgwrite "SOGO_TEMPLATESDIR=\${SOGO_SHARED}/templates"
    cfgwrite "SOGO_WEBSERVERRESOURCESDIR=\${SOGO_SHARED}/www"
    cfgwrite "SOGO_TOOLS=\${DESTDIR}\${FHS_INSTALL_ROOT}/bin"
    cfgwrite "SOGO_ADMIN_TOOLS=\${DESTDIR}\${FHS_INSTALL_ROOT}/sbin"
    cfgwrite "SOPE_SAXMAPPINGS=\${SOPE_SHARED}/saxmappings"
    cfgwrite "SOPE_SAXDRIVERS=\${SOPE_LIBDIR}/saxdrivers"
    cfgwrite "SOPE_WOXBUILDERS=\${SOPE_LIBDIR}/wox-builders"
    cfgwrite "SOGO_TYPEMODELS=\${SOGO_SYSSHAREDIR}/ocs"

    cfgwrite ""
  else
    cfgwrite "# configured for GNUstep install"
    cfgwrite ""
    cfgwrite "SOGO_SYSLIBDIR=\${GNUSTEP_LIBRARIES}"
    cfgwrite "SOGO_LIBDIR=\${GNUSTEP_LIBRARY}/SOGo-\${SOGO_MAJOR_VERSION}.\${SOGO_MINOR_VERSION}"
    cfgwrite "SOGO_TEMPLATESDIR=\${SOGO_LIBDIR}/Templates"
    cfgwrite "SOGO_WEBSERVERRESOURCESDIR=\${SOGO_LIBDIR}/WebServerResources"
    cfgwrite "SOGO_TOOLS=\${GNUSTEP_TOOLS}"
    cfgwrite "SOGO_ADMIN_TOOLS=\${GNUSTEP_ADMIN_TOOLS}"
    cfgwrite "SOPE_SAXMAPPINGS=\${GNUSTEP_LIBRARY}/SaxMappings"
    cfgwrite "SOPE_SAXDRIVERS=\${GNUSTEP_LIBRARY}/SaxDrivers-\${SOPE_MAJOR_VERSION}.\${SOPE_MINOR_VERSION}"
    cfgwrite "SOPE_WOXBUILDERS=\${GNUSTEP_LIBRARY}/WOxElemBuilders-\${SOPE_MAJOR_VERSION}.\${SOPE_MINOR_VERSION}"
    cfgwrite "SOGO_TYPEMODELS=\${GNUSTEP_LIBRARY}/OCSTypeModels"
  fi

  if test $ARG_WITH_STRIP = 1; then
    cfgwrite "# configured to produce stripped code";
    cfgwrite "strip:=yes"
  else
    cfgwrite "# configured not to strip code";
    cfgwrite "strip:=no"
  fi
  cfgwrite ""

  cfgwrite "# enforce shared libraries";
  cfgwrite "shared:=yes"
  cfgwrite ""
  
  cfgwrite "# GNUstep environment variables:";
  cfgwrite "GNUSTEP_INSTALLATION_DOMAIN=LOCAL"
  for i in `env | grep GNUSTEP_ | sort`; do
    MAKE_ASSI="`echo $i | sed s/=/:=/`"
    cfgwrite "${MAKE_ASSI}";
  done
  cfgwrite "LIBRARY_COMBO=$LIBRARY_COMBO"
  cfgwrite ""
  
}

checkLinking() {
  local oldpwd=$PWD
  local tmpdir=".configure-test-$$"
  
  mkdir $tmpdir
  cd $tmpdir
  cp ../maintenance/dummytool.m .
  
  tmpmake="GNUmakefile"
  echo  >$tmpmake "include ../config.make"
  echo >>$tmpmake "include \$(GNUSTEP_MAKEFILES)/common.make"
  echo >>$tmpmake "TOOL_NAME           := linktest"
  echo >>$tmpmake "linktest_OBJC_FILES := dummytool.m"
  echo >>$tmpmake "linktest_TOOL_LIBS  += -l$1"
  echo >>$tmpmake "SYSTEM_LIB_DIR      += ${LINK_SYSLIBDIRS}"
  echo >>$tmpmake "include \$(GNUSTEP_MAKEFILES)/tool.make"
  
  $MAKE -s messages=yes -f $tmpmake linktest >out.log 2>err.log
  LINK_RESULT=$?

  if test $LINK_RESULT = 0; then
    echo "$2 library found: $1"
  else
    if test "x$2" = "xrequired"; then
      echo "failed to link $2 library: $1"
      rm ../config.make
      exit 1
    else
      echo "failed to link $2 library: $1"
    fi
  fi
  
  cd $oldpwd
  rm -rf $tmpdir
}

checkDependencies() {
  checkLinking "SaxObjC" required;
  checkLinking "NGLdap"  required;
}

runIt() {
  if test $ARG_BEQUIET != 1; then
    printParas;
  fi
  
  if test $ARG_NOCREATE = 1; then 
    if test $ARG_BEQUIET != 1; then
      echo "not creating the config file ...";
    fi
  else
    genConfigMake;
    #checkDependencies;
    
    if test -x $NGSTREAMS_DIR/configure; then
      if test $ARG_BEQUIET != 1; then
        echo -n "configuring NGStreams library .."
        old="$PWD"
        cd $NGSTREAMS_DIR
        ./configure >$old/config-NGStreams.log
        cd $old
        echo ".. done (log in config-NGStreams.log)."
      fi
    fi
  fi
}

# ******************** options ********************

extractFuncValue() {
  VALUE="`echo "$1" | sed "s/[^=]*=//g"`"
}

processOption() {
  case "x$1" in
    "x--help"|"x-h")
	usage;
	;;
    "x--quiet"|"x--silent"|"x-q") ARG_BEQUIET=1;  ;;
    "x--no-create"|"x-n")	  ARG_NOCREATE=1; ;;
    x--prefix=*)
	extractFuncValue $1;
        ARG_PREFIX="$VALUE";
	;;
    x--gsmake=*)
	extractFuncValue $1;
        ARG_GSMAKE="$VALUE";
	;;
    x--configmake=*)
	extractFuncValue $1;
        ARG_CFGMAKE="$VALUE";
	;;
    "x--with-gnustep")
        ARG_WITH_GNUSTEP=1
        DARG_IS_FHS=0
	;;
    "x--without-gnustep")
        ARG_WITH_GNUSTEP=0
        DARG_IS_FHS=1
	;;
    "x--enable-debug")
        ARG_WITH_DEBUG=1
	;;
    "x--disable-debug")
        ARG_WITH_DEBUG=0
	;;
    "x--enable-strip")
        ARG_WITH_STRIP=1
	;;
    "x--disable-strip")
        ARG_WITH_STRIP=0
	;;

    *) echo "error: cannot process argument: $1"; exit 1; ;;
  esac
}

for i in $@; do
  processOption $i;
done

# load GNUstep environment
validateGNUstepArgs
# first we load the GNUstep.sh environment
. $DARG_GNUSTEP_SH
if test $ARG_BEQUIET != 1; then
  printGNUstepSetup;
fi

# setup some GNUstep dependend defaults
if test "x$GNUSTEP_HOST_VENDOR" = "xapple"; then
  setupAppleArgs;
fi

# ensure the parameters make sense
validateArgs

# start it
runIt
