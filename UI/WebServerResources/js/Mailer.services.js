!function(){"use strict";function c(e){"function"!=typeof e.then&&(angular.extend(this,e),_.forEach(this.identities,function(e){var t;e.fullName&&e.email?e.full=e.fullName+" <"+e.email+">":e.email?e.full="<"+e.email+">":e.full="",e.signature&&(t=angular.element("<div>"+e.signature+"</div>"),e.textSignature=_.map(t.contents(),"textContent").join(" ").trim())}),c.$log.debug("Account: "+JSON.stringify(e,void 0,2)))}c.$factory=["$q","$timeout","$log","sgSettings","Resource","Preferences","Mailbox","Message",function(e,t,n,s,i,o,a,r){return angular.extend(c,{$q:e,$timeout:t,$log:n,$$resource:new i(s.activeUser("folderURL")+"Mail",s.activeUser()),$Preferences:o,$Mailbox:a,$Message:r}),c}];try{angular.module("SOGo.MailerUI")}catch(e){angular.module("SOGo.MailerUI",["SOGo.Common"])}angular.module("SOGo.MailerUI").factory("Account",c.$factory),c.$findAll=function(e){return e?c.$unwrapCollection(e):c.$accounts?c.$q.when(c.$accounts):c.$$resource.fetch("","mailAccounts").then(function(e){return c.$unwrapCollection(e)})},c.$unwrapCollection=function(e){var n=[];return angular.forEach(e,function(e,t){e.id=t,n[t]=new c(e)}),c.$accounts=n},c.prototype.getLength=function(){return this.$expanded?this.$flattenMailboxes().length:0},c.prototype.getItemAtIndex=function(e){var t=this.$flattenMailboxes();return 0<=e&&e<t.length?t[e]:null},c.prototype.$getMailboxes=function(e){var o=this,t=e&&e.reload;return this.$mailboxes&&!t?c.$q.when(this.$mailboxes):(!t&&this.$futureMailboxesData||(this.$futureMailboxesData=c.$Mailbox.$find(this,e).then(function(e){var n=o.$flattenMailboxes({all:!0});o.$mailboxes=e,o.$expanded=!1;var s=function(e){_.forEach(e,function(e){var t=_.find(n,["id",e.id]);t&&(e.unseenCount=t.unseenCount),e.children&&0<e.children.length&&s(e.children)})};s(o.$mailboxes);var t,i=function(e){_.forEach(e,function(e){e.$expanded=0<=t.indexOf("/"+e.id),e.children&&0<e.children.length&&i(e.children)})};if(c.$Preferences.settings.Mail.ExpandedFolders){if(angular.isString(c.$Preferences.settings.Mail.ExpandedFolders))try{t=angular.fromJson(c.$Preferences.settings.Mail.ExpandedFolders)}catch(e){c.$log.warn("Can't parse list of expanded folders. String was: "+c.$Preferences.settings.Mail.ExpandedFolders),t=[]}else t=c.$Preferences.settings.Mail.ExpandedFolders;o.$expanded=0<=t.indexOf("/"+o.id),0<t.length&&i(o.$mailboxes)}return c.$accounts&&(o.$expanded|=1==c.$accounts.length),o.$flattenMailboxes({reload:!0}),o.$mailboxes})),this.$futureMailboxesData)},c.prototype.$flattenMailboxes=function(t){var n=[],s=[],i=function(e){_.forEach(e,function(e){n.push(e),(t&&t.all||e.$expanded)&&e.children&&0<e.children.length&&i(e.children)})};return!this.$$flattenMailboxes||t&&(t.reload||t.all)?(i(this.$mailboxes),t&&t.all||(this.$$flattenMailboxes=n,t&&t.saveState&&(_.forEach(c.$accounts,function(e){e.$expanded&&s.push("/"+e.id),_.reduce(e.$$flattenMailboxes,function(e,t){return t.$expanded&&e.push("/"+t.id),e},s)}),c.$$resource.post(null,"saveFoldersState",s)))):n=this.$$flattenMailboxes,n},c.prototype.$getMailboxByType=function(n){var s=function(e){var t=_.find(e,function(e){return e.type==n});return t||angular.forEach(e,function(e){!t&&e.children&&0<e.children.length&&(t=s(e.children))}),t};return s(this.$mailboxes)},c.prototype.$getMailboxByPath=function(n){var s=function(e){var t=_.find(e,function(e){return e.path==n});return t||angular.forEach(e,function(e){!t&&e.children&&0<e.children.length&&(t=s(e.children))}),t};return s(this.$mailboxes)},c.prototype.$newMailbox=function(e,t){var n=this;return c.$$resource.post(e.toString(),"createFolder",{name:t}).then(function(){n.$getMailboxes({reload:!0})})},c.prototype.getTextSignature=function(e){var t;return e.signature?(t=angular.element("<div>"+e.signature+"</div>"),e.textSignature=_.map(t.contents(),"textContent").join(" ").trim()):e.textSignature="",e.textSignature},c.prototype.$certificate=function(){var t=this;return this.security&&this.security.hasCertificate?this.$$certificate?c.$q.when(this.$$certificate):c.$$resource.fetch(this.id.toString(),"certificate").then(function(e){return t.$$certificate=e}):c.$q.reject()},c.prototype.$removeCertificate=function(){var e=this;return c.$$resource.fetch(this.id.toString(),"removeCertificate").then(function(){e.security.hasCertificate=!1})},c.prototype.updateQuota=function(e){var t=Math.round(1e4*e.usedSpace/e.maxQuota)/100,e=l("quotasFormat").formatted(t,Math.round(e.maxQuota/10.24)/100);this.$quota={percent:t,description:e}},c.prototype.$newMessage=function(s){var i=this;return c.$$resource.fetch(this.id.toString(),"compose").then(function(e){return c.$log.debug("New message (compose): "+JSON.stringify(e,void 0,2)),new c.$Message(e.accountId,i.$getMailboxByPath(e.mailboxPath),e)}).then(function(n){return c.$$resource.fetch(n.$absolutePath({asDraft:!0}),"edit").then(function(e){var t=c.$Preferences.defaults.AuxiliaryMailAccounts[i.id];return t.security&&(t.security.alwaysSign&&(e.sign=!0),t.security.alwaysEncrypt&&(e.encrypt=!0)),c.$log.debug("New message (edit): "+JSON.stringify(e,void 0,2)),angular.extend(n.editable,e),n.isNew=!0,s&&s.mailto&&(angular.isObject(s.mailto)?angular.extend(n.editable,s.mailto):n.$parseMailto(s.mailto)),n})})},c.prototype.$addDelegate=function(e){var t=this,n=c.$q.defer(),s={uid:e.uid};return!e.uid||-1<_.indexOf(_.map(this.delegates,"uid"),e.uid)?n.resolve():c.$$resource.fetch(this.id.toString(),"addDelegate",s).then(function(){t.delegates.push(e),n.resolve(t.users)},function(e,t){n.reject(l("An error occured, please try again."))}),n.promise},c.prototype.$removeDelegate=function(t){var n=this,e={uid:t};return c.$$resource.fetch(this.id.toString(),"removeDelegate",e).then(function(){var e=_.indexOf(_.map(n.delegates,"uid"),t);0<=e&&n.delegates.splice(e,1)})},c.prototype.$omit=function(){var n={},t=[],s=!1;return angular.forEach(this,function(e,t){"constructor"!=t&&"identities"!=t&&"$"!=t[0]&&(n[t]=angular.copy(e))}),_.forEach(this.identities,function(e){e.isReadOnly||t.push(_.pick(e,["email","fullName","replyTo","signature","isDefault"])),e.isDefault&&(s=e)}),n.identities=t,s&&n.forceDefaultIdentity||delete n.forceDefaultIdentity,n}}(),function(){"use strict";function u(e,t){this.$account=e,"function"!=typeof t.then?(this.init(t),this.name&&!this.path&&(e=u.$$resource.create("createFolder",this.name),this.$unwrap(e))):this.$unwrap(t)}u.$factory=["$q","$timeout","$log","sgSettings","Resource","Message","Acl","Preferences","sgMailbox_PRELOAD","sgMailbox_BATCH_DELETE_LIMIT",function(e,t,n,s,i,o,a,r,l,c){return angular.extend(u,{$q:e,$timeout:t,$log:n,$$resource:new i(s.activeUser("folderURL")+"Mail",s.activeUser()),$Message:o,$$Acl:a,$Preferences:r,$query:{sort:"arrival",asc:0},selectedFolder:null,$refreshTimeout:null,$virtualMode:!1,$virtualPath:!1,PRELOAD:l,BATCH_DELETE_LIMIT:c}),r.settings.Mail.SortingState&&(u.$query.sort=r.settings.Mail.SortingState[0],u.$query.asc=parseInt(r.settings.Mail.SortingState[1])),u}];try{angular.module("SOGo.MailerUI")}catch(e){angular.module("SOGo.MailerUI",["SOGo.Common"])}angular.module("SOGo.MailerUI").constant("sgMailbox_PRELOAD",{LOOKAHEAD:50,SIZE:100}).constant("sgMailbox_BATCH_DELETE_LIMIT",1e3).factory("Mailbox",u.$factory),u.$find=function(e,t){t=t&&t.all?this.$$resource.fetch(e.id.toString(),"viewAll"):this.$$resource.fetch(e.id.toString(),"view");return u.$unwrapCollection(e,t)},u.$unwrapCollection=function(s,e){var n=[],i=function(e,t){t.isSentFolder=t.isSentFolder||"sent"==t.type;for(var n=0;n<t.children.length;n++)t.children[n].level=e,t.children[n]=new u(s,t.children[n]),t.isSentFolder&&(t.children[n].isSentFolder=!0),i(e+1,t.children[n])};return e.then(function(e){return u.$timeout(function(){return angular.forEach(e.mailboxes,function(e,t){e.level=0;e=new u(s,e);i(1,e),n.push(e)}),e.quotas&&s.updateQuota(e.quotas),n})})},u.$absolutePath=function(e,t){var n=[];return(n=t?_.map(t.split("/"),function(e){return"folder"+e.asCSSIdentifier()}):n).splice(0,0,e),n.join("/")},u.prototype.init=function(e){(angular.isUndefined(this.uidsMap)||e.headers)&&(this.$isLoading=!0,this.$messages=[],this.uidsMap={}),angular.extend(this,e),this.path&&(this.id=this.$id(),this.$acl=new u.$$Acl("Mail/"+this.id),this.threaded&&(this.$collapsedThreads=[],u.$Preferences.settings.Mail.threadsCollapsed&&u.$Preferences.settings.Mail.threadsCollapsed["/"+this.id]&&(this.$collapsedThreads=u.$Preferences.settings.Mail.threadsCollapsed["/"+this.id]))),this.$displayName=this.name,this.type&&(this.$isEditable=this.isEditable(),this.$isSpecial=!0,"inbox"==this.type?(this.$displayName=l("InboxFolderName"),this.$icon="inbox"):"draft"==this.type?(this.$displayName=l("DraftsFolderName"),this.$icon="drafts"):"sent"==this.type?(this.$displayName=l("SentFolderName"),this.$icon="send"):"trash"==this.type?(this.$displayName=l("TrashFolderName"),this.$icon="delete"):"junk"==this.type?(this.$displayName=l("JunkFolderName"),this.$icon="thumb_down"):"additional"==this.type?this.$icon="folder_shared":(this.$isSpecial=!1,this.$icon="folder")),this.$isNoInferiors=this.isNoInferiors(),angular.isUndefined(this.$shadowData)&&(this.$shadowData=this.$omit())},u.prototype.selectFolder=function(){u.$virtualMode||(u.selectedFolder=this)},u.prototype.getLength=function(){var n=!1;return _.filter(this.$messages,function(e,t){return e.first?n=e.collapsed:e.level<0&&(n=!1),e.first||!1===n}).length},u.prototype.getItemAtIndex=function(e){var t,n=!1,s=_.filter(this.$messages,function(e,t){return e.first?n=e.collapsed:e.level<0&&(n=!1),e.first||!1===n});return 0<=e&&e<s.length&&(t=s[e],this.$lastVisibleIndex=Math.max(0,e-3),this.$loadMessage(t.uid))?t:null},u.prototype.$id=function(){return u.$absolutePath(this.$account.id,this.path)},u.prototype.$selectedMessages=function(){return _.filter(this.$messages,function(e){return e.selected})},u.prototype.$selectedCount=function(){return this.$selectedMessages().length},u.prototype.$unselectMessages=function(){_.forEach(this.$selectedMessages(),function(e){e.selected=!1})},u.prototype.isSelectedMessage=function(e){return this.selectedMessage==e},u.prototype.$selectedMessage=function(){var t=this;return _.find(this.$messages,function(e){return e.uid==t.selectedMessage})},u.prototype.$selectedMessageIndex=function(){return this.uidsMap[this.selectedMessage]},u.prototype.hasSelectedMessage=function(){return angular.isDefined(this.selectedMessage)},u.prototype.$filter=function(e,t){var n={};angular.isDefined(this.unseenCount)||(this.unseenCount=0),this.$isLoading=!0,u.$refreshTimeout&&u.$timeout.cancel(u.$refreshTimeout),e&&angular.extend(u.$query,e),angular.extend(n,{sortingAttributes:u.$query}),angular.isDefined(t)&&(n.filters=_.reject(angular.copy(t),function(e){return!e.searchInput||0===e.searchInput.length}),_.forEach(n.filters,function(e){var t=e.searchBy.match(/(\w+)_or_(\w+)/);t&&(n.sortingAttributes.match="OR",e.searchBy=t[1],(e=angular.copy(e)).searchBy=t[2],n.filters.push(e))})),u.$virtualMode||(s=u.$Preferences.defaults.SOGoRefreshViewCheck)&&"manually"!=s&&(t=angular.bind(this,u.prototype.$filter,null,t),u.$refreshTimeout=u.$timeout(t,1e3*s.timeInterval()));var s=u.$$resource.post(this.id,"view",n);return this.$unwrap(s)},u.prototype.$loadMessage=function(e){var t,n,s,i=this.uidsMap[e],o=this.$messages.length,a=!1;if(angular.isDefined(this.uidsMap[e])&&i<this.$messages.length&&(angular.isDefined(this.$messages[i].subject)&&(a=!0),t=Math.min(i+u.PRELOAD.LOOKAHEAD,o-1),angular.isDefined(this.$messages[t].subject)||angular.isDefined(this.$messages[t].loading)?(s=Math.max(i-u.PRELOAD.LOOKAHEAD,0),angular.isDefined(this.$messages[s].subject)||angular.isDefined(this.$messages[s].loading)||(t=i,i=Math.max(i-u.PRELOAD.SIZE,0))):t=Math.min(i+u.PRELOAD.SIZE,o-1),!angular.isDefined(this.$messages[i].subject)&&!angular.isDefined(this.$messages[i].loading)||!angular.isDefined(this.$messages[t].subject)&&!angular.isDefined(this.$messages[t].loading))){for(n=[];i<t&&i<o;i++)angular.isDefined(this.$messages[i].subject)||this.$messages[i].loading?t++:(n.push(this.$messages[i].uid),this.$messages[i].loading=!0);n.length&&(u.$log.debug("Loading UIDs "+n.join(" ")),s=u.$$resource.post(this.id,"headers",{uids:n}),this.$unwrapHeaders(s))}return a},u.prototype.isEditable=function(){return"folder"==this.type},u.prototype.isNoInferiors=function(){return 0<=this.flags.indexOf("noinferiors")},u.prototype.isNoSelect=function(){return 0<=this.flags.indexOf("noselect")},u.prototype.getClassName=function(e){return!1},u.prototype.$rename=function(){var s,e,i,o,a=this;return this.name==this.$shadowData.name?u.$q.when():(e=(s=function(e,t){var n=null;return _.find(t,function(e){return e.path==a.path})?n=e:angular.forEach(t,function(e){!n&&e.children&&0<e.children.length&&(n=s(e,e.children))}),n})(null,this.$account.$mailboxes),i=null===e?this.$account.$mailboxes:e.children,o=_.indexOf(_.map(i,"id"),this.id),this.$save().then(function(e){var t=a.path;a.init(e),i.splice(o,1),e=_.find(i,function(e){return"folder"==e.type&&0<e.name.localeCompare(a.name)}),o=e?_.indexOf(_.map(i,"id"),e.id):i.length,i.splice(o,0,a);var n=new RegExp("^"+t),s=function(e){_.forEach(e.children,function(e){e.path=e.path.replace(n,a.path),e.id=e.$id(),s(e)})};s(a)}))},u.prototype.$compact=function(){var t=this;return u.$$resource.post(this.id,"expunge").then(function(e){return e.quotas&&t.$account.updateQuota(e.quotas),!0})},u.prototype.$canFolderAs=function(){return"folder"==this.type},u.prototype.$setFolderAs=function(e){return u.$$resource.post(this.id,"setAs"+e+"Folder")},u.prototype.$emptyTrash=function(){var t=this;return u.$$resource.post(this.id,"emptyTrash").then(function(e){t.$messages=[],t.uidsMap={},t.unseenCount=0,angular.isDefined(t.children)&&t.children.length&&t.$account.$getMailboxes({reload:!0}),e.quotas&&t.$account.updateQuota(e.quotas)})},u.prototype.$markAsRead=function(){var e=this;return u.$$resource.post(this.id,"markRead").then(function(){e.unseenCount=0,_.forEach(e.$messages,function(e){e.isread=!0})})},u.prototype.$flagMessages=function(e,t,n){n={msgUIDs:_.map(e,"uid"),flags:t,operation:n};return u.$$resource.post(this.id,"addOrRemoveLabel",n).then(function(){return e})},u.prototype.saveSelectedMessages=function(){var e=_.filter(this.$messages,function(e){return e.selected}),e=_.map(e,"uid");l("Saved Messages.zip");return u.$$resource.download(this.id,"saveMessages",{uids:e})},u.prototype.exportFolder=function(){var e={filename:this.name+".zip"};return u.$$resource.open(this.id,"exportFolder",null,e)},u.prototype.$delete=function(e){var t=this;return u.$$resource.post(this.id,"delete",e).then(function(){return t.$account.$getMailboxes({reload:!0}),!0})},u.prototype.$_deleteMessages=function(s,e){var i=this,o=this.$messages.length,e=_.filter(e,function(e,t){return!e.isread});return this.unseenCount-=e.length,_.forEachRight(this.$messages,function(t,e){var n=_.findIndex(s,function(e){return t.uid==e});-1<n?(s.splice(n,1),delete i.uidsMap[t.uid],t.uid==i.selectedMessage&&delete i.selectedMessage,i.$messages.splice(e,1),e<o&&(o=e)):i.uidsMap[t.uid]-=s.length}),o},u.prototype.$deleteMessages=function(o,a){var r,l=this,c=u.BATCH_DELETE_LIMIT;return r=_.map(o,"uid"),function t(e,n){var s=r.slice(e,n),i=o.slice(e,n),e={uids:s};return a&&angular.extend(e,a),u.$$resource.post(l.id,"batchDelete",e).then(function(e){return n<r.length?(l.$_deleteMessages(s,i),t(n,Math.min(n+c,r.length))):(e.quotas&&l.$account.updateQuota(e.quotas),l.$_deleteMessages(s,i))})}(0,Math.min(c,r.length))},u.prototype.$markOrUnMarkMessagesAsJunk=function(e){var t=_.map(e,"uid"),e="junk"==this.type?"markMessagesAsNotJunk":"markMessagesAsJunk";return u.$$resource.post(this.id,e,{uids:t})},u.prototype.$copyMessages=function(e,t){var n=this,e=_.map(e,"uid");return u.$$resource.post(this.id,"copyMessages",{uids:e,folder:t}).then(function(e){e.quotas&&n.$account.updateQuota(e.quotas)})},u.prototype.$moveMessages=function(e,t){var n=this,s=_.map(e,"uid");return u.$$resource.post(this.id,"moveMessages",{uids:s,folder:t}).then(function(){return n.$_deleteMessages(s,e)})},u.prototype.$reset=function(){var n=this;angular.forEach(this.$shadowData,function(e,t){delete n[t]}),angular.extend(this,this.$shadowData),this.$shadowData=this.$omit()},u.prototype.$move=function(e){var t=this;return u.$$resource.post(this.id,"move",{parent:e}).finally(function(){return t.$account.$getMailboxes({reload:!0}),!0})},u.prototype.$save=function(){var t=this;return u.$$resource.save(this.id,this.$omit()).then(function(e){return t.$shadowData=t.$omit(),u.$log.debug(JSON.stringify(e,void 0,2)),e},function(e){return u.$log.error(JSON.stringify(e.data,void 0,2)),t.$reset(),e.data})},u.prototype.$newMailbox=function(e,t){return this.$account.$newMailbox(e,t)},u.prototype.$omit=function(){var n={};return angular.forEach(this,function(e,t){"constructor"!=t&&"children"!=t&&"headers"!=t&&"uids"!=t&&"uidsMap"!=t&&"$"!=t[0]&&(n[t]=e)}),n},u.prototype.$unwrap=function(e){var r=this,s=u.$q.defer();return this.$futureMailboxData=e,this.$futureMailboxData.then(function(t){var a=_.map(r.$selectedMessages(),"uid");u.$timeout(function(){var o,e,n;(!t.uids||r.$topIndex>t.uids.length-1)&&(r.$topIndex=0),t.uids&&(u.$log.debug("unwrapping "+t.uids.length+" messages"),r.init(t),r.threaded&&(o=r.uids[0],r.uids.splice(0,1)),_.reduce(r.uids,function(e,t,n){var s;if(r.threaded){if(1===(s=_.zipObject(o,t)).first){for(var i=1;r.uids[n+i]&&0<=r.uids[n+i][1]&&1!==r.uids[n+i][2];)i++;s.count=i,s.collapsed=!1,0<=r.$collapsedThreads.indexOf(s.uid.toString())&&(s.collapsed=!0)}}else s={uid:t.toString()};return r.uidsMap[s.uid]=n,s.selected=-1<a.indexOf(s.uid),e.push(s),e},r.$messages)),t.headers&&(n=_.invokeMap(t.headers.splice(0,1)[0],"toLowerCase"),e=t.headers,_.forEach(e,function(e){var t=_.zipObject(n,e),e=r.uidsMap[t.uid.toString()];r.$messages[e]instanceof u.$Message||(r.$messages[e]=new u.$Message(r.$account.id,r,r.$messages[e],!0)),r.$messages[e].init(t)})),u.$log.debug("mailbox "+r.id+" ready"),r.$isLoading=!1,s.resolve(r.$messages)})},function(e){u.$log.error(e),angular.extend(r,e),r.isError=!0,r.$isLoading=!1,s.reject()}),s.promise},u.prototype.$unwrapHeaders=function(e){var s=this;e.then(function(e){u.$timeout(function(){var t,n;0<e.length&&(t=_.invokeMap(e[0],"toLowerCase"),e.splice(0,1),_.forEach(e,function(e){e=_.zipObject(t,e),n=s.uidsMap[e.uid.toString()],angular.isDefined(n)&&(s.$messages[n]instanceof u.$Message||(s.$messages[n]=new u.$Message(s.$account.id,s,s.$messages[n],!0)),s.$messages[n].init(e))}))})})},u.prototype.$updateSubscribe=function(){var e=this.subscribed?"subscribe":"unsubscribe";u.$$resource.post(this.id,e)}}(),function(){"use strict";function r(e,t,n,s){this.accountId=e,this.$mailbox=t,this.$hasUnsafeContent=!1,this.$loadUnsafeContent=!1,this.editable={to:[],cc:[],bcc:[]},this.selected=!1,"function"!=typeof n.then?(!angular.isUndefined(s)&&s||this.init(n),this.uid=parseInt(n.uid),this.level=parseInt(n.level),this.first=1===parseInt(n.first),this.first?(this.threadCount=parseInt(n.count),this.collapsed=!0===n.collapsed):!isNaN(this.level)&&0<=this.level&&(this.threadMember=!0)):this.$unwrap(n)}r.$factory=["$q","$timeout","$log","sgSettings","sgMessage_STATUS","Resource","Preferences",function(e,t,n,s,i,o,a){return angular.extend(r,{STATUS:i,$q:e,$timeout:t,$log:n,$$resource:new o(s.activeUser("folderURL")+"Mail",s.activeUser()),$Preferences:a,$avatar:angular.bind(a,a.avatar)}),a.defaults.SOGoMailLabelsColors&&(r.$tags=a.defaults.SOGoMailLabelsColors),a.defaults.SOGoMailDisplayRemoteInlineImages&&"always"==a.defaults.SOGoMailDisplayRemoteInlineImages&&(r.$displayRemoteInlineImages=!0),r}];try{angular.module("SOGo.MailerUI")}catch(e){angular.module("SOGo.MailerUI",["SOGo.Common"])}angular.module("SOGo.MailerUI").constant("sgMessage_STATUS",{NOT_LOADED:0,DELAYED_LOADING:1,LOADING:2,LOADED:3,DELAYED_MS:300}).factory("Message",r.$factory),r.filterTags=function(e,n){var s=new RegExp(e,"i"),i=[];return _.forEach(_.keys(r.$tags),function(e){var t=r.$tags[e];-1!=t[0].search(s)&&(_.includes(n,e)||i.push({name:e,description:t[0],color:t[1]}))}),i},r.prototype.init=function(e){var n=this;angular.extend(this,e),this.$formatFullAddresses(),this.$loadUnsafeContent=!1,_.forEach(this.flags,function(e,t){"$"==e.charAt(0)&&n.flags.splice(t,1,"_"+e)})},r.prototype.$absolutePath=function(e){var t=this,n=this.id;function s(){var e=_.map(t.$mailbox.path.split("/"),function(e){return"folder"+e.asCSSIdentifier()});return e.splice(0,0,t.accountId),e.join("/")}return(angular.isUndefined(this.id)||e&&e.nocache)&&(this.id=s()+"/"+this.uid,n=this.id),e&&e.asDraft&&this.draftId&&(n=s()+"/"+this.draftId),n=e&&e.withResourcePath?r.$$resource.path(n):n},r.prototype.$setUID=function(e){var t,n=this.uid||-1,s=this;n!=parseInt(e)&&(this.uid=parseInt(e),this.$absolutePath({nocache:!0}),-1<n?(n=n.toString(),angular.isDefined(this.$mailbox.uidsMap[n])&&(t=this.$mailbox.uidsMap[n],this.$mailbox.uidsMap[e]=t,delete this.$mailbox.uidsMap[n],this.$mailbox.$messages[t].uid=this.uid,_.forEach(["from","to","subject"],function(e){s.$mailbox.$messages[t][e]=s.editable[e]}))):this.$mailbox.constructor.selectedFolder&&"draft"==this.$mailbox.constructor.selectedFolder.type&&this.$mailbox.constructor.selectedFolder.$filter())},r.prototype.$formatFullAddresses=function(){var t=this,n=_.map(t.$mailbox.$account.identities,"email");_.forEach(["from","to","cc","bcc","reply-to"],function(e){_.forEach(t[e],function(e){e.name&&e.name!=e.email?(e.full=e.name+" <"+e.email+">",e.name.length<10?e.shortname=e.name:e.name.split(" ").length&&(e.shortname=_.first(_.last(e.name.split(/, */)).split(/ +/)).replace("'",""))):e.email&&(e.full="<"+e.email+">",e.shortname=e.email.split("@")[0]),e.image=r.$avatar(e.email,32),0<=_.indexOf(n,e.email)&&(e.shortname=l("me"))})})},r.prototype.$shortRecipients=function(n){var t=this,s=[],i=0,o=0;return _.forEach(["to","cc","bcc"],function(e){o+=t[e]?t[e].length:0,_.forEach(t[e],function(e,t){i<n&&s.push(e.shortname),i++})}),n<o&&s.push(l("and %{0} more...",o-n)),s.join(", ")},r.prototype.$shortAddress=function(e){var t="";return t=this[e]&&0<this[e].length?this[e][0].name||this[e][0].email||"":t},r.prototype.allowReplyAll=function(){var s=_.map(this.$mailbox.$account.identities,"email"),e=_.reduce(["to","cc","bcc","reply-to"],_.bind(function(e,t){var n=0;return this[t]?(n=this[t].length,_.forEach(this[t],function(e){0<=_.indexOf(s,e.email)&&n--}),e+n):e},this),0);return!this.isDraft&&1<e},r.prototype.loadUnsafeContent=function(){this.$loadUnsafeContent=!0,delete this.$parts},r.prototype.$content=function(){var e=this,t=[],n=function(o){o.msgclass="msg-attachment-other","UIxMailPartAlternativeViewer"==o.type?n(_.find(o.content,function(e){return o.preferredPart==e.contentType})):angular.isArray(o.content)?("UIxMailPartSignedViewer"==o.type&&1===o["supports-smime"]?e.signed={valid:o.valid,certificate:o.certificates[o.certificates.length-1],message:o.message}:"UIxMailPartEncryptedViewer"==o.type&&(o.encrypted&&(e.encrypted={valid:o.decrypted},o.decrypted?e.encrypted.message=l("This message is encrypted"):e.encrypted.message=l("This message can't be decrypted. Please make sure you have uploaded your S/MIME certificate from the mail preferences module.")),o.opaqueSigned&&(e.signed={valid:o.valid,certificate:o.certificates[o.certificates.length-1],message:o.message})),_.forEach(o.content,function(e){n(e)})):(angular.isUndefined(o.safeContent)&&(o.safeContent=o.content,e.$hasUnsafeContent|=-1<o.safeContent.indexOf(" unsafe-")),"UIxMailPartHTMLViewer"==o.type?(o.html=!0,e.$loadUnsafeContent||r.$displayRemoteInlineImages?(angular.isUndefined(o.unsafeContent)&&(o.unsafeContent=document.createElement("div"),o.unsafeContent.innerHTML=o.safeContent,angular.forEach(["src","data","classid","background","style"],function(e){for(var t,n,s=o.unsafeContent.querySelectorAll("[unsafe-"+e+"]"),i=0;i<s.length;i++)n=(t=angular.element(s[i])).attr("unsafe-"+e),t.attr(e,n),t.removeAttr("unsafe-"+e)}),e.$hasUnsafeContent=!1),o.content=o.unsafeContent.innerHTML):o.content=o.safeContent):"UIxMailPartICalViewer"==o.type||"UIxMailPartImageViewer"==o.type||"UIxMailPartLinkViewer"==o.type?("UIxMailPartImageViewer"==o.type?o.msgclass="msg-attachment-image":"UIxMailPartLinkViewer"==o.type&&(o.msgclass="msg-attachment-link"),o.compile=!0):(o.html=!0,o.content=o.safeContent),t.push(o))};return this.$parts||(this.parts&&n(this.parts),this.$parts=t)},r.prototype.$editableContent=function(){var n=this;return r.$$resource.fetch(this.$absolutePath(),"edit").then(function(e){return angular.extend(n,e),r.$$resource.fetch(n.$absolutePath({asDraft:!0}),"edit").then(function(t){var e=_.find(n.$mailbox.$account.identities,function(e){return t.from&&-1!==t.from.toLowerCase().indexOf(e.email)});e&&(t.from=e.full);e=r.$Preferences.defaults.AuxiliaryMailAccounts[n.$mailbox.$account.id];return e.security&&(e.security.alwaysSign&&(t.sign=!0),e.security.alwaysEncrypt&&(t.encrypt=!0)),r.$log.debug("editable = "+JSON.stringify(t,void 0,2)),angular.extend(n.editable,t),t.text})})},r.prototype.$plainContent=function(){return r.$$resource.fetch(this.$absolutePath(),"viewplain")},r.prototype.addTag=function(e){return this.$addOrRemoveTag("add",e)},r.prototype.removeTag=function(e){return this.$addOrRemoveTag("remove",e)},r.prototype.$addOrRemoveTag=function(e,t){e={operation:e,msgUIDs:[this.uid],flags:t.replace(/^_\$/,"$")};if(t)return r.$$resource.post(this.$mailbox.$id(),"addOrRemoveLabel",e)},r.prototype.$imipAction=function(e,t,n){var s=this;r.$$resource.post([this.$absolutePath(),e].join("/"),t,n).then(function(e){r.$timeout(function(){s.$reload()})})},r.prototype.$sendMDN=function(){return this.shouldAskReceipt=0,r.$$resource.post(this.$absolutePath(),"sendMDN")},r.prototype.$deleteAttachment=function(t){var e={filename:t},n=this;r.$$resource.fetch(this.$absolutePath({asDraft:!0}),"deleteAttachment",e).then(function(e){r.$timeout(function(){n.editable.attachmentAttrs=_.filter(n.editable.attachmentAttrs,function(e){return e.filename!=t})})})},r.prototype.toggleFlag=function(){var t=this,e="markMessageFlagged";return this.isflagged&&(e="markMessageUnflagged"),r.$$resource.post(this.$absolutePath(),e).then(function(e){r.$timeout(function(){t.isflagged=!t.isflagged})})},r.prototype.toggleThread=function(){var e="markMessageCollapse";return this.collapsed&&(e="markMessageUncollapse"),this.collapsed=!this.collapsed,r.$$resource.post(this.$absolutePath(),e)},r.prototype.$isLoading=function(){return this.$loaded==r.STATUS.LOADING},r.prototype.$reload=function(e){var t=this;return e&&e.useCache&&this.$futureMessageData?(this.isread||r.$$resource.fetch(this.$absolutePath(),"markMessageRead").then(function(){r.$timeout(function(){t.isread=!0,t.$mailbox.unseenCount--})}),this):(e=r.$$resource.fetch(this.$absolutePath(e),"view"),this.$unwrap(e))},r.prototype.$parseMailto=function(n){var e,s,i=/^mailto:([^\?]+)/.exec(n);i&&(e=_.map(decodeURIComponent(i[1]).split(","),function(e){return"<"+e.trim()+">"}),s={to:e},_.forEach(["subject","body"],function(e){var t=new RegExp(e+"=([^&]+)");e="body"==e?"text":e,(i=t.exec(n))&&(s[e]=decodeURIComponent(i[1]))}),_.forEach(["cc","bcc"],function(e){var t=new RegExp(e+"=([^&]+)");(i=t.exec(n))&&(s[e]=_.map(decodeURIComponent(i[1]).split(","),function(e){return"<"+e.trim()+">"}))}),angular.extend(this.editable,s))},r.prototype.$reply=function(){return this.$newDraft("reply")},r.prototype.$replyAll=function(){return this.$newDraft("replyall")},r.prototype.$forward=function(){return this.$newDraft("forward")},r.prototype.$newDraft=function(s){var i=this;return r.$$resource.fetch(this.$absolutePath(),s).then(function(e){var t,n;return r.$log.debug("New "+s+": "+JSON.stringify(e,void 0,2)),t=i.$mailbox.$account.$getMailboxByPath(e.mailboxPath),n=new r(e.accountId,t,e),r.$$resource.fetch(n.$absolutePath({asDraft:!0}),"edit").then(function(e){r.$log.debug("New "+s+": "+JSON.stringify(e,void 0,2)+" original UID: "+i.uid);var t=r.$Preferences.defaults.AuxiliaryMailAccounts[i.$mailbox.$account.id];return t.security&&(t.security.alwaysSign&&(e.sign=!0),t.security.alwaysEncrypt&&(e.encrypt=!0)),e.isHTML&&((t=angular.element("<div>"+e.text+"</div>")).find("meta").remove(),t.find("link").remove(),t.find("base").remove(),t.find("title").remove(),e.text=t.html()),angular.extend(n.editable,e),n.origin={message:i,action:s},n})})},r.prototype.$save=function(){var t=this,e=this.$omit();return r.$log.debug("save = "+JSON.stringify(e,void 0,2)),r.$$resource.save(this.$absolutePath({asDraft:!0}),e).then(function(e){r.$log.debug("save = "+JSON.stringify(e,void 0,2)),t.$setUID(e.uid),t.$reload(),t.isNew=!1})},r.prototype.$send=function(){var t=this,e=this.$omit();return r.$log.debug("send = "+JSON.stringify(e,void 0,2)),r.$$resource.post(this.$absolutePath({asDraft:!0}),"send",e).then(function(e){return"success"==e.status?(angular.isDefined(t.origin)&&(t.origin.action.startsWith("reply")?t.origin.message.isanswered=!0:"forward"==t.origin.action&&(t.origin.message.isforwarded=!0)),e):r.$q.reject(e.data)})},r.prototype.$unwrap=function(e){var t=this;return this.$loaded=r.STATUS.DELAYED_LOADING,r.$timeout(function(){t.$loaded!=r.STATUS.LOADED&&(t.$loaded=r.STATUS.LOADING)},r.STATUS.DELAYED_MS),this.$futureMessageData=e.then(function(e){return 0===t.isread&&(t.isread=!0,t.$mailbox.unseenCount--),r.$timeout(function(){return delete t.$parts,t.$loaded=r.STATUS.LOADED,t.init(e),t})}),this.$futureMessageData},r.prototype.$omit=function(e){var n={},s=e&&e.privateAttributes,e=s?this:this.editable;return angular.forEach(e,function(e,t){_.includes(["to","cc","bcc"],t)&&!s?n[t]=_.map(e,function(e){return e.toString()}):("constructor"!=t&&"$"!=t[0]||s)&&(n[t]=e)}),n},r.prototype.download=function(){var e={uids:[this.uid]},t={filename:this.subject+".zip"};return r.$$resource.download(this.$mailbox.id,"saveMessages",e,t)},r.prototype.downloadAttachments=function(){var e={filename:l("attachments")+"-"+this.uid+".zip"};return r.$$resource.download(this.$absolutePath(),"archiveAttachments",null,e)}}(),function(){"use strict";function u(){this.show=!1,this.message=null,this.elements=[]}u.$factory=["$document","$timeout","$mdPanel","sgHotkeys",function(e,t,n,s){return angular.extend(u,{$document:e,$timeout:t,$mdPanel:n,sgHotkeys:s}),new u}],u.prototype.setMessage=function(e){this.message=e},u.prototype.registerImage=function(e){this.elements.push(e)},u.prototype.registerHotkeys=function(e){this.keys=[u.sgHotkeys.createHotkey({key:"left",description:l("View previous item"),callback:angular.bind(e,e.previousImage)}),u.sgHotkeys.createHotkey({key:"right",description:l("View next item"),callback:angular.bind(e,e.nextImage)})],_.forEach(this.keys,function(e){u.sgHotkeys.registerHotkey(e)})},u.prototype.showGallery=function(e,t){var n=this,s=u.$mdPanel,i=angular.element(this.message.$content()[t].content).find("img")[0].src,o=_.filter(this.message.attachmentAttrs,function(e){return 0===e.mimetype.indexOf("image/")}),a=_.findIndex(o,function(e){return 0<=e.url.indexOf(i)});angular.element(u.$document[0].body).addClass("sg-image-gallery-backdrop");var r=s.newPanelPosition().absolute(),t=s.newPanelAnimation().openFrom(e.target).duration(100).withAnimation(s.animation.FADE),e={attachTo:angular.element(document.body),locals:{lastIndex:o.length-1,images:o,selectedIndex:a,selectedImage:o[a]},bindToController:!0,controller:c,controllerAs:"$panelCtrl",position:r,animation:t,targetEvent:e,fullscreen:!0,hasBackdrop:!0,template:['<sg-image-gallery layout="column">','  <div class="md-toolbar-tools" layout="row" layout-align="space-between center">','    <md-button class="md-icon-button"','                aria-label="'+l("Close")+'"','                ng-click="$panelCtrl.close()">',"      <md-icon>arrow_back</md-icon>","    </md-button>",'    <md-icon class="md-primary">image</md-icon>','    <div md-truncate class="md-flex" ng-bind="$panelCtrl.selectedImage.filename"></div>','    <md-button class="md-icon-button"','                aria-label="'+l("Save Attachment")+'"','                ng-href="{{$panelCtrl.selectedImage.urlAsAttachment}}">',"      <md-icon>file_download</md-icon>","    </md-button>","  </div>",'  <div class="md-flex" layout="row" layout-align="space-between center">','      <md-button class="md-icon-button" ng-click="$panelCtrl.previousImage()"','                 ng-disabled="$panelCtrl.selectedIndex == 0">',"        <md-icon>navigate_before</md-icon>","      </md-button>",'      <img class="sg-image" ng-src="{{$panelCtrl.selectedImage.url}}">','      <md-button class="md-icon-button" ng-click="$panelCtrl.nextImage()"','                 ng-disabled="$panelCtrl.selectedIndex == $panelCtrl.lastIndex">',"        <md-icon>navigate_next</md-icon>","      </md-button>","  </div>",'    <div class="sg-image-thumbnails">','      <div class="sg-image-thumbnail" ng-repeat="image in ::$panelCtrl.images">','        <img class="sg-hide" ng-src="{{::image.url}}" ng-click="$panelCtrl.selectImage($index)">',"      </div>","    </div>","</sg-image-gallery>"].join(""),trapFocus:!0,clickOutsideToClose:!0,escapeToClose:!0,focusOnOpen:!0,onOpenComplete:function(){n.show=!0,_.forEach(u.$document.find("sg-image-gallery")[0].getElementsByClassName("sg-image-thumbnail"),function(e){var t=e.children[0];angular.element(t).one("load",function(){t.naturalWidth<t.naturalHeight&&t.classList.add("portrait")}),u.$timeout(function(){t.classList.remove("sg-hide")},1e3)})},onDomRemoved:function(){angular.element(u.$document[0].body).removeClass("sg-image-gallery-backdrop"),n.show=!1,_.forEach(n.hotkeys,function(e){u.sgHotkeys.deregisterHotkey(e)})}};function c(e){(e.$ctrl=this).close=function(){e.close()},this.selectImage=function(e){this.selectedIndex=e,this.selectedImage=this.images[e]},this.nextImage=function(){this.selectedIndex!=this.lastIndex&&this.selectImage(this.selectedIndex+1)},this.previousImage=function(){0<this.selectedIndex&&this.selectImage(this.selectedIndex-1)}}s.open(e).then(function(e){n.registerHotkeys(e.$ctrl)}),c.$inject=["mdPanelRef"]},angular.module("SOGo.MailerUI").factory("ImageGallery",u.$factory)}(),function(){"use strict";function l(e){this.$account=e}l.$factory=["$q","$timeout","$log","sgSettings","Resource","Message","Mailbox","sgMailbox_PRELOAD",function(e,t,n,s,i,o,a,r){return angular.extend(l,{$q:e,$timeout:t,$log:n,$$resource:new i(s.activeUser("folderURL")+"Mail",s.activeUser()),$Message:a,selectedFolder:null,PRELOAD:r}),l}];try{angular.module("SOGo.MailerUI")}catch(e){angular.module("SOGo.MailerUI",["SOGo.Common"])}angular.module("SOGo.MailerUI").constant("sgMailbox_PRELOAD",{LOOKAHEAD:50,SIZE:100}).factory("VirtualMailbox",l.$factory),l.$absolutePath=function(e){return[e,"virtual"].join("/")},l.prototype.init=function(e){this.$isLoading=!1,this.$mailboxes=[],this.uidsMap={},angular.extend(this,e),this.id=this.$id()},l.prototype.setMailboxes=function(e){this.$mailboxes=e,_.forEach(this.$mailboxes,function(e){e.$messages=[],e.uidsMap={}})},l.prototype.startSearch=function(t,n){var s=this,i=l.$q.when();this.$isLoading=!0,_.forEach(this.$mailboxes,function(e){i=i.then(function(){if(s.$isLoading)return l.$log.debug("searching mailbox "+e.path),e.$filter({sort:"date",asc:!1,match:t},n)})}),i.finally(function(){s.$isLoading=!1})},l.prototype.stopSearch=function(){l.$log.debug("stopping search..."),this.$isLoading=!1},l.prototype.selectFolder=function(){},l.prototype.resetSelectedMessage=function(){_.forEach(this.$mailboxes,function(e){delete e.selectedMessage})},l.prototype.hasSelectedMessage=function(){return angular.isDefined(_.find(this.$mailboxes,function(e){return angular.isDefined(e.selectedMessage)}))},l.prototype.isSelectedMessage=function(t,n){return angular.isDefined(_.find(this.$mailboxes,function(e){return e.path==n&&e.selectedMessage==t}))},l.prototype.getLength=function(){var t=0;return angular.isDefined(this.$mailboxes)&&_.forEach(this.$mailboxes,function(e){t+=e.$messages.length}),t},l.prototype.getItemAtIndex=function(e){var t,n,s,i,o;if(angular.isDefined(this.$mailboxes)&&0<=e)for(n=t=0;n<this.$mailboxes.length;n++)for(i=this.$mailboxes[n],s=0;s<i.$messages.length;t++,s++)if(t==e&&(o=i.$messages[s],i.$loadMessage(o.uid)))return o;return null},l.prototype.$id=function(){return l.$absolutePath(this.$account.id)},l.prototype.$selectedMessageIndex=function(){var t=0,e=_.find(this.$mailboxes,function(e){return!!angular.isDefined(e.selectedMessage)||(t+=e.getLength(),!1)});return t+e.uidsMap[e.selectedMessage]},l.prototype.$selectedMessages=function(){return _.filter(_.transform(this.$mailboxes,function(e,t){e[t.id]=t.$selectedMessages()},{}),function(e){return 0<_.size(e)})},l.prototype.$selectedCount=function(){return _.sum(_.invokeMap(this.$mailboxes,"$selectedCount"))},l.prototype.$flagMessages=function(e,t,n){var s={flags:t,operation:n},i=[],o=[];return _.forEach(e,function(e,t){var n;0<e.length&&(n=_.map(e,"uid"),i.push(e),n=l.$$resource.post(t,"addOrRemoveLabel",_.assign(s,{msgUIDs:n})),o.push(n))}),l.$q.all(o).then(function(){return _.flatten(i)})},l.prototype.$deleteMessages=function(e){var n=this,s=[];if(_.isArray(e)&&1===e.length){var t=e[0],i=t.$mailbox;return i.$deleteMessages([t]).then(function(e){var t=0;return _.find(n.$mailboxes,function(e){return e.id===i.id||(t+=e.getLength(),!1)}),t+e})}return _.forEach(e,function(e,t){0<e.length&&(e=e[0].$mailbox.$deleteMessages(e),s.push(e))}),l.$q.all(s)},l.prototype.$markOrUnMarkMessagesAsJunk=function(e){var n=[];return _.forEach(e,function(e,t){0<e.length&&(e=e[0].$mailbox.$markOrUnMarkMessagesAsJunk(e),n.push(e))}),l.$q.all(n)},l.prototype.$copyMessages=function(e,n){var s=[];return _.forEach(e,function(e,t){0<e.length&&(e=e[0].$mailbox.$copyMessages(e,n),s.push(e))}),l.$q.all(s)},l.prototype.$moveMessages=function(e,n){var s=[];return _.forEach(e,function(e,t){0<e.length&&(e=e[0].$mailbox.$moveMessages(e,n),s.push(e))}),l.$q.all(s)},l.prototype.$comact=function(){return!0}}(),function(){"use strict";function e(i,o,a,r,c,u,d,e,n,s,h,g,f,t,m,p,$,b){var v,y=this,M=angular.element(i.document).find("title").attr("sg-default")||"SOGo",x=[];function C(e){return!!b.$virtualMode||y.selectedFolder.$compact()}function w(e){var t=y.selectedFolder.$selectedMessageIndex();return angular.isDefined(t)?(t--,0<y.selectedFolder.$topIndex&&y.selectedFolder.$topIndex--):(t=y.selectedFolder.getLength()-1,y.selectedFolder.$topIndex=y.selectedFolder.getLength()),-1<t&&y.selectMessage(y.selectedFolder.getItemAtIndex(t)),e.preventDefault(),t}function I(e){var t=y.selectedFolder.$selectedMessageIndex();return angular.isDefined(t)?(t++,y.selectedFolder.$topIndex<y.selectedFolder.getLength()&&y.selectedFolder.$topIndex++):t=0,t<y.selectedFolder.getLength()?y.selectMessage(y.selectedFolder.getItemAtIndex(t)):t=-1,e.preventDefault(),t}function S(e){var t;y.selectedFolder.hasSelectedMessage()&&0<=(t=w(e))&&y.toggleMessageSelection(e,y.selectedFolder.$messages[t])}function E(e){var t;y.selectedFolder.hasSelectedMessage()&&0<=(t=I(e))&&y.toggleMessageSelection(e,y.selectedFolder.$messages[t])}function A(){return b.$virtualMode?y.selectedFolder.$mailboxes:[y.selectedFolder]}function F(e,t){var n,s,i=t;y.mode.multiple=y.selectedFolder.$selectedCount(),e?(0<t&&(n=y.selectedFolder.$messages[--i]),t<y.selectedFolder.$messages.length&&(s=y.selectedFolder.$messages[t]),n?n.isread&&s&&!s.isread&&(i=t,n=s):s&&(i=t,n=s),n?(y.selectedFolder.$topIndex=i,c.go("mail.account.mailbox.message",{messageId:n.uid})):c.go("mail.account.mailbox")):a(function(){console.warn("go to mailbox"),c.go("mail.account.mailbox")})}v={subject:"Subject",from:"From",date:"Date",size:"Size",arrival:"Order Received"},this.$onInit=function(){var t;i.$mailboxController=y,this.service=b,this.accounts=e,this.account=n,this.selectedFolder=s,this.messageDialog=null,this.mode={search:!1,multiple:0},(t=x).push(h.createHotkey({key:l("hotkey_search"),description:l("Search"),callback:y.searchMode})),t.push(h.createHotkey({key:l("hotkey_compose"),description:l("Write a new message"),callback:function(e){null===y.messageDialog&&y.newMessage(e)}})),t.push(h.createHotkey({key:l("hotkey_junk"),description:l("Mark the selected messages as junk"),callback:y.markOrUnMarkMessagesAsJunk})),t.push(h.createHotkey({key:"space",description:l("Toggle item"),callback:y.toggleMessageSelection})),t.push(h.createHotkey({key:"shift+space",description:l("Toggle range of items"),callback:y.toggleMessageSelection})),t.push(h.createHotkey({key:"up",description:l("View next item"),callback:w,preventInClass:["sg-mail-part"]})),t.push(h.createHotkey({key:"down",description:l("View previous item"),callback:I,preventInClass:["sg-mail-part"]})),t.push(h.createHotkey({key:"shift+up",description:l("Add next item to selection"),callback:S,preventInClass:["sg-mail-part"]})),t.push(h.createHotkey({key:"shift+down",description:l("Add previous item to selection"),callback:E,preventInClass:["sg-mail-part"]})),_.forEach(["backspace","delete"],function(e){t.push(h.createHotkey({key:e,description:l("Delete selected message or folder"),callback:y.confirmDeleteSelectedMessages}))}),_.forEach(t,function(e){h.registerHotkey(e)}),angular.element(i).on("beforeunload",C),o.$on("$destroy",function(){angular.element(i).off("beforeunload",C),_.forEach(x,function(e){h.deregisterHotkey(e)})}),o.$watch(function(){return y.selectedFolder.unseenCount},function(e){var t="";e&&(t+="("+e+") "),t+=y.selectedFolder.$displayName,i.document.title=t+=" | "+M})},this.centerIsClose=function(e){return this.selectedFolder.hasSelectedMessage()&&!!e},this.sort=function(e){if(!e)return v[y.service.$query.sort];y.selectedFolder.$filter({sort:e})},this.sortedBy=function(e){return b.$query.sort==e},this.ascending=function(){return b.$query.asc},this.refresh=function(){p.pollInbox(),this.selectedFolder.$filter()},this.searchMode=function(e){y.mode.search=!0,t("search"),e&&e.preventDefault()},this.cancelSearch=function(){y.mode.search=!1,y.selectedFolder.$filter().then(function(){y.selectedFolder.selectedMessage&&a(function(){y.selectedFolder.$topIndex=y.selectedFolder.uidsMap[y.selectedFolder.selectedMessage]})})},this.composeWindowEnabled=function(){return p.defaults.SOGoMailComposeWindowEnabled},this.newMessage=function(e,t){var n,s=r.defer();null===y.messageDialog&&(t||"popup"==p.defaults.SOGoMailComposeWindow?(t=[f.baseURL(),"UIxMailPopupView#!/Mail",y.account.id,g(g(y.selectedFolder.path)),"new"].join("/"),n=y.selectedFolder.$id()+"/"+Math.random(0,1e3),i.open(t,n,["width=680","height=520","resizable=1","scrollbars=1","toolbar=0","location=0","directories=0","status=0","menubar=0","copyhistory=0"].join(","))):(n=y.account.$newMessage(),y.messageDialog=u.show({parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!1,escapeToClose:!1,templateUrl:"UIxMailEditor",controller:"MessageEditorController",controllerAs:"editor",onComplete:function(e,t){return s.resolve(t)},locals:{stateParent:o,stateAccount:y.account,stateMessage:n,onCompletePromise:function(){return s.promise}}}).catch(_.noop).finally(function(){y.messageDialog=null})))},this.selectMessage=function(e){b.$virtualMode?c.go("mail.account.virtualMailbox.message",{mailboxId:g(e.$mailbox.path),messageId:e.uid}):c.go("mail.account.mailbox.message",{messageId:e.uid})},this.toggleMessageSelection=function(e,t){var n,s,i,o=y.selectedFolder;if(!(t=t||o.$selectedMessage()))return!0;if(t.selected=!t.selected,y.mode.multiple+=t.selected?1:-1,e.shiftKey&&1<o.$selectedCount()){for(s=(n=o.uidsMap[t.uid])-2;0<=s&&!o.$messages[s].selected;)s--;if(s<0)for(s=n+2;s<o.getLength()&&!o.$messages[s].selected;)s++;if(0<=s&&s<o.getLength())for(i=Math.min(n,s);i<=Math.max(n,s);i++)o.$messages[i].selected=!0}e.preventDefault(),e.stopPropagation()},this.confirmDeleteSelectedMessages=function(e){var n=y.selectedFolder.$selectedMessages();null===y.messageDialog&&0<_.size(n)&&(y.messageDialog=m.confirm(l("Confirmation"),l("Are you sure you want to delete the selected messages?"),{ok:l("Delete")}).then(function(){var t=y.selectedFolder.hasSelectedMessage();y.selectedFolder.$deleteMessages(n).then(function(e){b.$virtualMode?t&&c.go("mail.account.virtualMailbox"):F(t,e)},function(e){y.messageDialog=m.confirm(l("Warning"),l("The messages could not be moved to the trash folder. Would you like to delete them immediately?"),{ok:l("Delete")}).then(function(){y.selectedFolder.$deleteMessages(n,{withoutTrash:!0}).then(function(e){b.$virtualMode?t&&c.go("mail.account.virtualMailbox"):F(t,e)}).finally(function(){y.messageDialog=null})})})}).finally(function(){y.messageDialog=null})),e.preventDefault()},this.markOrUnMarkMessagesAsJunk=function(){var t=y.selectedFolder.hasSelectedMessage(),n=y.selectedFolder.$selectedMessages();0===_.size(n)&&t&&(n=[y.selectedFolder.$selectedMessage()]),0<_.size(n)&&y.selectedFolder.$markOrUnMarkMessagesAsJunk(n).then(function(){var e="/"+y.account.id+"/folderINBOX";"junk"!=y.selectedFolder.type&&(e="/"+y.account.$getMailboxByType("junk").id),y.selectedFolder.$moveMessages(n,e).then(function(e){b.$virtualMode?t&&c.go("mail.account.virtualMailbox"):F(t,e)})})},this.copySelectedMessages=function(e){var t=y.selectedFolder.$selectedMessages();0<_.size(t)&&y.selectedFolder.$copyMessages(t,"/"+e).then(function(){d.show(d.simple().textContent(l("%{0} message(s) copied",y.selectedFolder.$selectedCount())).position("top right").hideDelay(2e3))})},this.moveSelectedMessages=function(e){var t=y.selectedFolder.hasSelectedMessage(),n=y.selectedFolder.$selectedMessages(),s=y.selectedFolder.$selectedCount();0<_.size(n)&&y.selectedFolder.$moveMessages(n,"/"+e).then(function(e){d.show(d.simple().textContent(l("%{0} message(s) moved",s)).position("top right").hideDelay(2e3)),b.$virtualMode?t&&c.go("mail.account.virtualMailbox"):F(t,e)})},this.selectAll=function(){var s=0;_.forEach(A(),function(e){for(var t=0,n=e.$messages.length;t<n;t++)e.$messages[t].selected=!0;s+=n}),y.mode.multiple=s},this.unselectMessages=function(){_.forEach(A(),function(e){_.forEach(e.$messages,function(e){e.selected=!1})}),y.mode.multiple=0},this.markSelectedMessagesAsFlagged=function(){var e=y.selectedFolder.$selectedMessages();0<_.size(e)&&y.selectedFolder.$flagMessages(e,"\\Flagged","add").then(function(e){_.forEach(e,function(e){e.isflagged=!0})})},this.markSelectedMessagesAsUnread=function(){var e=y.selectedFolder.$selectedMessages();0<_.size(e)&&y.selectedFolder.$flagMessages(e,"seen","remove").then(function(e){_.forEach(e,function(e){e.isread&&e.$mailbox.unseenCount++,e.isread=!1})})},this.markSelectedMessagesAsRead=function(){var e=y.selectedFolder.$selectedMessages();0<_.size(e)&&y.selectedFolder.$flagMessages(e,"seen","add").then(function(e){_.forEach(e,function(e){e.isread||e.$mailbox.unseenCount--,e.isread=!0})})}}function t(e){return e[0].controller.prototype.resetScroll=function(){"messagesList"==this.$element.parent().attr("id")?this.updateSize():this.scrollTo(0)},e}e.$inject=["$window","$scope","$timeout","$q","$state","$mdDialog","$mdToast","stateAccounts","stateAccount","stateMailbox","sgHotkeys","encodeUriFilter","sgSettings","sgFocus","Dialog","Preferences","Account","Mailbox"],angular.module("SOGo.MailerUI").controller("MailboxController",e),t.$inject=["$delegate"],angular.module("material.components.virtualRepeat").decorator("mdVirtualRepeatContainerDirective",t)}(),function(){"use strict";function e(e,c,t,n,s,i,o,a,r,u,d,h,g,f,m,p,$,b,v,y,M,x){var C,w,I=this,S=[];this.$onInit=function(){var t;this.service=b,this.accounts=x,this.currentSearchParam="",this.search={options:{"":"",subject:l("Enter Subject"),from:l("Enter From"),to:l("Enter To"),cc:l("Enter Cc"),body:l("Enter Body")},subfolders:1,match:"AND",params:[]},this.showSubscribedOnly=M.defaults.SOGoMailShowSubscribedFoldersOnly,this.refreshUnseenCount(),t=S,_.forEach(["backspace","delete"],function(e){t.push(p.createHotkey({key:e,description:l("Delete selected message or folder"),callback:function(){b.selectedFolderController&&b.selectedFolder&&b.selectedFolder.$isEditable&&!b.selectedFolder.hasSelectedMessage()&&0===b.selectedFolder.$selectedCount()&&b.selectedFolderController.confirmDelete(b.selectedFolder)}}))}),_.forEach(t,function(e){p.registerHotkey(e)}),e.$on("$destroy",function(){_.forEach(S,function(e){p.deregisterHotkey(e)})})},this.hideAdvancedSearch=function(){I.service.$virtualPath=!1,I.service.$virtualMode=!1,C=I.accounts[0],w=I.searchPreviousMailbox,c.go("mail.account.mailbox",{accountId:C.id,mailboxId:g(w.path)})},this.toggleAdvancedSearch=function(){var e,t,n;b.selectedFolder.$isLoading?I.virtualMailbox.stopSearch():(t=[],n=function(e){_.forEach(e,function(e){e.isNoSelect()||t.push(e),e.children&&0<e.children.length&&n(e.children)})},I.virtualMailbox=new v(I.accounts[0]),b.$virtualMode||(I.searchPreviousMailbox=b.selectedFolder),b.selectedFolder=I.virtualMailbox,b.$virtualMode=!0,b.$virtualPath.length?(e=I.accounts[0].$getMailboxByPath(b.$virtualPath),t.push(e),I.search.subfolders&&e.children.length&&n(e.children)):t=_.filter(I.accounts[0].$flattenMailboxes({all:!0}),function(e){return!e.isNoSelect()}),I.virtualMailbox.setMailboxes(t),I.virtualMailbox.startSearch(I.search.match,I.search.params),"mail.account.virtualMailbox"!=c.$current.name&&c.go("mail.account.virtualMailbox",{accountId:I.accounts[0].id}))},this.addSearchParam=function(e){return this.currentSearchParam=e,h("advancedSearch"),!1},this.newSearchParam=function(e){if(e.length&&this.currentSearchParam.length){var t=0,n=this.currentSearchParam;return e.startsWith("!")&&(e=e.substring(t=1).trim()),this.currentSearchParam="",{searchBy:n,searchInput:e,negative:t}}},this.toggleAccountState=function(e){e.$expanded=!e.$expanded,this.debounceSaveState||(this.debounceSaveState=i.debounce(function(){e.$flattenMailboxes({reload:!0,saveState:!0})},1e3)),this.debounceSaveState()},this.subscribe=function(e){function t(e,t,n){var s=this;s.loading=!0,s.filter={name:""},s.account=new $({id:n.id,name:n.name}),s.close=function(){t.hide()},s.account.$getMailboxes({reload:!0,all:!0}).then(function(){s.loading=!1})}r.show({templateUrl:e.id+"/subscribe",controller:t,controllerAs:"subscriptions",clickOutsideToClose:!0,escapeToClose:!0,locals:{srcAccount:e}}).finally(function(){e.$getMailboxes({reload:!0})}),t.$inject=["$scope","$mdDialog","srcAccount"]},this.showAdvancedSearch=function(){b.$virtualPath="",o(d["gt-md"])||a("left").close()},this.newFolder=function(e){f.prompt(l("New Folder..."),l("Enter the new name of your folder")).then(function(n){e.$newMailbox(e.id,n).then(function(){},function(e,t){f.alert(l('An error occured while creating the mailbox "%{0}".',n),l(e.error))})})},this.delegate=function(e){function t(e,t,n,s){var i=this;i.users=s.delegates,i.account=s,i.userToAdd="",i.searchText="",i.userFilter=function(e){return n.$filter(e,s.delegates)},i.closeModal=function(){t.hide()},i.removeUser=function(e){s.$removeDelegate(e.uid).catch(function(e,t){f.alert(l("Warning"),l("An error occured, please try again."))})},i.addUser=function(e){e&&s.$addDelegate(e).then(function(){i.userToAdd="",i.searchText=""},function(e){f.alert(l("Warning"),e)})}}r.show({templateUrl:e.id+"/delegation",controller:t,controllerAs:"delegate",clickOutsideToClose:!0,escapeToClose:!0,locals:{User:y,account:e}}),t.$inject=["$scope","$mdDialog","User","account"]},this.refreshUnseenCount=function(){var e,t=1===M.defaults.SOGoMailFetchAllUnseenCountFolders?[]:s.unseenCountFolders;_.forEach(I.accounts,function(e){1===M.defaults.SOGoMailFetchAllUnseenCountFolders?_.forEach(e.$$flattenMailboxes,function(e){t.push(e.id)}):(_.includes(t,e.id+"/folderINBOX")||t.push(e.id+"/folderINBOX"),_.forEach(e.$$flattenMailboxes,function(e){angular.isDefined(e.unseenCount)&&!_.includes(t,e.id)&&t.push(e.id)}))}),$.$$resource.post("","unseenCount",{mailboxes:t}).then(function(t){_.forEach(I.accounts,function(e){_.forEach(e.$$flattenMailboxes,function(e){t[e.id]&&(e.unseenCount=t[e.id])})})}),(e=M.defaults.SOGoRefreshViewCheck)&&"manually"!=e&&n(I.refreshUnseenCount,1e3*e.timeInterval())},this.isDroppableFolder=function(e,t){return t.id!=e.id&&!t.isNoSelect()},this.dragSelectedMessages=function(e,t,n){var s,i,o,a="/"+t.id,r=e.$selectedMessages();0===r.length&&(r=[e.$selectedMessage()]),t=_.map(r,"uid"),s=e.selectedMessage&&0<=t.indexOf(e.selectedMessage),o="copy"==n?(i=e.$copyMessages(r,a),l("%{0} message(s) copied",r.length)):(i=e.$moveMessages(r,a),l("%{0} message(s) moved",r.length)),i.then(function(){s&&c.go("mail.account.mailbox"),u.show(u.simple().textContent(o).position("top right").hideDelay(2e3))})}}e.$inject=["$scope","$state","$transitions","$timeout","$window","$mdUtil","$mdMedia","$mdSidenav","$mdDialog","$mdToast","sgConstant","sgFocus","encodeUriFilter","Dialog","sgSettings","sgHotkeys","Account","Mailbox","VirtualMailbox","User","Preferences","stateAccounts"],angular.module("SOGo.MailerUI").controller("MailboxesController",e)}(),function(){"use strict";function e(s,i,o,c,u,a,r,d,n,h,g,f,m,p,$,b,t,v,y,M,x,e,C,w,I,S){var E=this,A=[];function F(e){return i.mailbox?(0<arguments.length&&(i.mailbox.messageDialog=e),i.mailbox.messageDialog):null}function D(e){return function(){if(null===F())return e.apply(E,arguments)}}function k(){var e,t={};return s.opener&&"$mailboxController"in s.opener&&"selectedFolder"in s.opener.$mailboxController&&s.opener.$mailboxController.selectedFolder.$id()==g.$id()&&(e=s.opener.$mailboxController,t.mailboxCtrl=e,"$messageController"in s.opener&&s.opener.$messageController.message.uid==f.uid&&(e=s.opener.$messageController,t.messageCtrl=e)),t}function O(e,t){var n;null===F()&&(n=o.defer(),F(a.show({parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!1,escapeToClose:!1,templateUrl:"UIxMailEditor",controller:"MessageEditorController",controllerAs:"editor",onComplete:function(e,t){return n.resolve(t)},locals:{stateParent:i,stateAccount:E.account,stateMessage:t,onCompletePromise:function(){return n.promise}}}).catch(_.noop).finally(function(){F(null),E.closePopup()})))}function P(n,s){E.message.$plainContent().then(function(e){var t={pid:M.$defaultCalendar(),type:s,summary:e.subject,comment:e.content},e=new x(t),t=[$.activeUser("folderURL"),"Calendar","UIx"+s.capitalize()+"EditorTemplate"].join("/");return a.show({parent:angular.element(document.body),targetEvent:n,clickOutsideToClose:!0,escapeToClose:!0,templateUrl:t,controller:"ComponentEditorController",controllerAs:"editor",locals:{stateComponent:e}})})}this.$onInit=function(){var t,e=!1;s.$messageController=E,b.setMessage(f),this.$state=c,this.accounts=n,this.account=h,this.mailbox=g,this.message=f,this.service=w,this.tags={searchText:"",selected:""},this.showFlags=f.flags&&0<f.flags.length,this.$alwaysShowDetailedRecipients=(!f.to||f.to.length<5)&&(!f.cc||f.cc.length<5),this.$showDetailedRecipients=this.$alwaysShowDetailedRecipients,this.showRawSource=!1,(t=A).push(m.createHotkey({key:l("hotkey_reply"),description:l("Reply to the message"),callback:D(angular.bind(E,E.reply))})),t.push(m.createHotkey({key:l("hotkey_replyall"),description:l("Reply to sender and all recipients"),callback:D(angular.bind(E,E.replyAll))})),t.push(m.createHotkey({key:l("hotkey_forward"),description:l("Forward selected message"),callback:D(angular.bind(E,E.forward))})),t.push(m.createHotkey({key:l("hotkey_flag"),description:l("Flagged"),callback:D(angular.bind(f,f.toggleFlag))})),_.forEach(["backspace","delete"],function(e){t.push(m.createHotkey({key:e,callback:D(function(e){0===E.mailbox.$selectedCount()&&E.deleteMessage(),e.preventDefault()})}))}),_.forEach(t,function(e){m.registerHotkey(e)});try{e=s.opener&&"$mailboxController"in s.opener}catch(e){}e?(i.$watchCollection(function(){return E.message.flags},function(e,t){var n;(e||t)&&(n=k()).messageCtrl&&n.messageCtrl.service.$timeout(function(){n.messageCtrl.showFlags=!0,n.messageCtrl.message.flags=e})}),i.$watch(function(){return E.message.isflagged},function(e,t){var n=k();n.mailboxCtrl&&n.mailboxCtrl.service.$timeout(function(){_.find(n.mailboxCtrl.selectedFolder.$messages,{uid:E.message.uid}).isflagged=e})})):i.$watchCollection(function(){return E.message.flags},function(e,t){var n,s;(e||t)&&(n=e||[],t=t||[],_.forEach(n,function(e,t){angular.isObject(e)&&(n[t]=e.name)}),n.length>t.length?(s=_.difference(n,t),_.forEach(s,function(e){E.message.addTag(e)})):n.length<t.length&&(s=_.difference(t,n),_.forEach(s,function(e){E.message.removeTag(e)})))}),i.$on("$destroy",function(){_.forEach(A,function(e){m.deregisterHotkey(e)})})},this.addFlags=function(e){e.stopPropagation(),e.preventDefault(),this.showFlags=!0,t("flags")},this.toggleDetailedRecipients=function(e){this.$showDetailedRecipients=!this.$showDetailedRecipients,e.stopPropagation(),e.preventDefault()},this.focusChip=function(e){for(var t=e.target;"MD-CHIP"!==t.tagName;)t=t.parentNode;t.classList.add("md-focused")},this.blurChip=function(e){for(var t=e.target;"MD-CHIP"!==t.tagName;)t=t.parentNode;t.classList.remove("md-focused"),e.relatedTarget&&"MD-CHIP-TEMPLATE"===e.relatedTarget.tagName&&E.panel.close()},this.selectRecipient=function(e,t){I.$findAll([]);var n=t.target,s=r.newPanelPosition().relativeTo(n).addPanelPosition(r.xPosition.ALIGN_START,r.yPosition.ALIGN_TOPS),i=r.newPanelAnimation().openFrom(n).duration(100).withAnimation(r.animation.FADE),i={attachTo:angular.element(document.body),locals:{recipient:e,addressbooks:I.$addressbooks,subscriptions:I.$subscriptions,newMessage:angular.bind(this,this.newMessage)},bindToController:!0,controller:o,controllerAs:"$menuCtrl",position:s,animation:i,targetEvent:t,templateUrl:"UIxMailViewRecipientMenu",trapFocus:!0,clickOutsideToClose:!0,escapeToClose:!0,focusOnOpen:!1};function o(s,e,i){this.onKeyDown=function(e){9===e.which&&s.close()},this.newCard=function(e,t){var n=new S({pid:t,c_cn:e.name,emails:[{value:e.email}]});n.$id().then(function(e){n.$save().then(function(){i.show(i.simple().textContent(l("Successfully created card")).position("top right").hideDelay(2e3))})}),s.close()}}r.open(i).then(function(e){(E.panel=e).panelEl.one("click",function(){e.close()})}),o.$inject=["mdPanelRef","$state","$mdToast"],"A"===n.tagName&&(t.stopPropagation(),t.preventDefault())},this.filterMailtoLinks=function(e){var t;"A"==e.target.tagName&&"href"in e.target.attributes&&(t=e.target.attributes.href.value,/^mailto:([^\?]+)/.exec(t)&&(delete e.target.attributes.target,this.newMessage(e,t)))},this.deleteMessage=function(){var n,s,i,o,a,e=k(),r=this.service.$timeout;function t(e){var t=e;if(s=null,angular.isDefined(i)){0<e&&(o=n.getItemAtIndex(--t)),e<n.getLength()&&(a=n.getItemAtIndex(e)),o?o.isread&&a&&!a.isread&&(t=e,o=a):a&&(t=e,o=a);try{o&&u(d["gt-md"])?(C.$virtualMode?i.go("mail.account.virtualMailbox.message",{mailboxId:p(o.$mailbox.path),messageId:o.uid}):i.go("mail.account.mailbox.message",{messageId:o.uid}),r(function(){t<n.$topIndex?n.$topIndex=t:t>n.$lastVisibleIndex&&(n.$topIndex=t-(n.$lastVisibleIndex-n.$topIndex))})):i.go("mail.account.mailbox").then(function(){s=null,delete n.selectedMessage})}catch(e){}}E.closePopup()}i=e.messageCtrl?(n=e.mailboxCtrl.selectedFolder,s=e.messageCtrl.message,e.messageCtrl.$state):(n=g,s=f,c),(n=C.$virtualMode?C.selectedFolder:n).$deleteMessages([s]).then(t,function(e){F(v.confirm(l("Warning"),l("The message could not be moved to the trash folder. Would you like to delete it immediately?"),{ok:l("Delete")}).then(function(){n.$deleteMessages([s],{withoutTrash:!0}).then(t).finally(function(){F(null)})}).finally(function(){F(null)}))})},this._showMailEditorInPopup=function(e){return!$.isPopup&&"popup"==y.defaults.SOGoMailComposeWindow&&(this.openInPopup(e),!0)},this.close=function(){var e=C.$virtualMode?"mail.account.virtualMailbox":"mail.account.mailbox";c.go(e).then(function(){E.message=null,delete g.selectedMessage})},this.reply=function(e){this._showMailEditorInPopup("reply")||O(e,this.message.$reply())},this.replyAll=function(e){this._showMailEditorInPopup("replyall")||O(e,this.message.$replyAll())},this.forward=function(e){this._showMailEditorInPopup("forward")||O(e,this.message.$forward())},this.edit=function(e){this._showMailEditorInPopup("edit")||this.message.$editableContent().then(function(){O(e,E.message)})},this.openInPopup=function(e){var t=[$.baseURL(),"UIxMailPopupView#!/Mail",this.message.accountId,p(p(this.message.$mailbox.path)),this.message.uid].join("/"),n=this.message.$absolutePath();e&&(t+="/"+e),s.open(t,n,["width=680","height=520","resizable=1","scrollbars=1","toolbar=0","location=0","directories=0","status=0","menubar=0","copyhistory=0"].join(","))},this.closePopup=function(){s.document.body.classList.contains("popup")&&s.close()},this.newMessage=function(t,e){"A"===t.target.tagName&&(t.stopPropagation(),t.preventDefault()),this.account.$newMessage({mailto:e}).then(function(e){O(t,e)})},this.toggleRawSource=function(e){this.showRawSource||this.message.$rawSource?this.showRawSource=!this.showRawSource:w.$$resource.post(this.message.id,"viewsource").then(function(e){E.message.$rawSource=e,E.showRawSource=!0})},this.print=function(e){s.print()},this.convertToEvent=function(e){return P(e,"appointment")},this.convertToTask=function(e){return P(e,"task")}}e.$inject=["$window","$scope","$q","$state","$mdMedia","$mdDialog","$mdPanel","sgConstant","stateAccounts","stateAccount","stateMailbox","stateMessage","sgHotkeys","encodeUriFilter","sgSettings","ImageGallery","sgFocus","Dialog","Preferences","Calendar","Component","Account","Mailbox","Message","AddressBook","Card"],angular.module("SOGo.MailerUI").controller("MessageController",e)}(),function(){"use strict";function e(e,n,t,s,i,o,a,r,c,u,d,h,g,f,m,p,$,b,v){var y=this;function M(){var e,t={};try{n.opener&&"$mailboxController"in n.opener&&"selectedFolder"in n.opener.$mailboxController&&("draft"==n.opener.$mailboxController.selectedFolder.type?(t.draftMailboxCtrl=n.opener.$mailboxController,"$messageController"in n.opener&&n.opener.$messageController.message.uid==d.uid&&(t.draftMessageCtrl=n.opener.$messageController)):d.origin&&(e=d.origin.message,n.opener.$mailboxController.selectedFolder.$id()==e.$mailbox.$id()&&(t.originMailboxCtrl=n.opener.$mailboxController)))}catch(e){}return t}function x(){y.uploader.url=y.message.$absolutePath({asDraft:!0,withResourcePath:!0})+"/save"}function C(){var e,t,n=y.message.editable.attachmentAttrs;if(n)for(e=0;e<n.length;e++)t={name:n[e].filename,type:n[e].mimetype,size:parseInt(n[e].size)},(t=new r.FileItem(y.uploader,t)).progress=100,t.isUploaded=!0,t.isSuccess=!0,t.inlineUrl=n[e].url,y.uploader.queue.push(t)}function w(e,t){e.isUploading?y.uploader.cancelItem(e):(y.message.$deleteAttachment(e.file.name),e.remove());t=n.document.getElementById(t);t&&angular.element(t).prop("value",null)}function I(){y.autosave&&f.cancel(y.autosave),y.message.isNew&&y.message.attachmentAttrs&&y.message.$mailbox.$deleteMessages([y.message]),o.cancel()}function S(){y.isFullscreen=!y.isFullscreen}function E(e){return $.$filterAll(e).then(function(e){var t=[];return _.forEach(_.invokeMap(e,"explode"),function(e){_.forEach(e,function(e){t.push(e)})}),_.uniqBy(t,function(e){return e.$$fullname+" "+e.$$email})})}function A(){y.message.$save(),v.defaults.SOGoMailAutoSave&&(y.autosave=f(y.autosaveDrafts,1e3*v.defaults.SOGoMailAutoSave*60))}this.$onInit=function(){e.isPopup=c.isPopup,this.account=u,this.autocomplete={to:{},cc:{},bcc:{}},this.autosave=null,this.autosaveDrafts=A,this.cancel=I,this.contactFilter=E,this.isFullscreen=!1,this.hideBcc=0===d.editable.bcc.length,this.hideCc=0===d.editable.cc.length,this.identities=u.identities,this.fromIdentity=d.editable.from,this.identitySearchText="",this.message=d,this.recipientSeparatorKeys=[s.KEY_CODE.ENTER,s.KEY_CODE.TAB,s.KEY_CODE.COMMA,s.KEY_CODE.SEMICOLON],this.removeAttachment=w,this.sendState=!1,this.toggleFullscreen=S,this.firstFocus=!0,y.uploader=new r({url:y.message.$absolutePath({asDraft:!0,withResourcePath:!0})+"/save",autoUpload:!0,alias:"attachments",removeAfterUpload:!1,onSuccessItem:function(e,t,n,s){y.message.$setUID(t.uid),y.message.$reload(),e.inlineUrl=t.lastAttachmentAttrs[0].url,e.file.name=t.lastAttachmentAttrs[0].filename},onCancelItem:function(e,t,n,s){y.message.$deleteAttachment(e.file.name),this.removeFromQueue(e)},onErrorItem:function(e,t,n,s){a.show(a.simple().textContent(l('Error while uploading the file "%{0}":',e.file.name)+" "+(t.message?l(t.message):"")).position("top right").action(l("OK")).hideDelay(!1)),this.removeFromQueue(e)}}),v.defaults.SOGoMailAutoSave&&(this.autosave=f(this.autosaveDrafts,1e3*v.defaults.SOGoMailAutoSave*60)),this.localeCode=v.defaults.LocaleCode,this.ckConfig={language:v.defaults.LocaleCode},this.composeType=v.defaults.SOGoMailComposeMessageType,this.signaturePlacement=v.defaults.SOGoMailSignaturePlacement,this.replyPlacement=v.defaults.SOGoMailReplyPlacement,this.message.origin&&"forward"==this.message.origin.action&&(this.replyPlacement="above"),e.$on("$destroy",function(){y.uploader.destroy()}),"reply"==t.actionName?d.$reply().then(function(e){y.message=e,y.fromIdentity=e.editable.from,y.hideCc=!e.editable.cc||0===e.editable.cc.length,y.hideBcc=!e.editable.bcc||0===e.editable.bcc.length,x()}):"replyall"==t.actionName?d.$replyAll().then(function(e){y.message=e,y.fromIdentity=e.editable.from,y.hideCc=!e.editable.cc||0===e.editable.cc.length,y.hideBcc=!e.editable.bcc||0===e.editable.bcc.length,x()}):"forward"==t.actionName?d.$forward().then(function(e){y.message=e,y.fromIdentity=e.editable.from,x(),C()}):angular.isDefined(d)&&(this.message=d,x(),C())},this.save=function(){var t=M();this.message.$save().then(function(e){y.message.$rawSource=null,t.draftMailboxCtrl&&t.draftMailboxCtrl.selectedFolder.$filter().then(function(){t.draftMessageCtrl&&t.draftMessageCtrl.$state.go("mail.account.mailbox.message",{messageId:y.message.uid})}),a.show(a.simple().textContent(l("Your email has been saved")).position("top right").hideDelay(3e3))})},this.send=function(){this.sendState="sending",this.autosave&&f.cancel(this.autosave),this.message.$send().then(function(e){var t=M();y.sendState="sent",t.draftMailboxCtrl&&t.draftMailboxCtrl.selectedFolder.$filter().then(function(){t.draftMessageCtrl&&t.draftMessageCtrl.close()}),t.originMailboxCtrl&&t.originMailboxCtrl.selectedFolder.$filter(),a.show(a.simple().textContent(l("Your email has been sent")).position("top right").hideDelay(3e3)),f(o.hide,1e3)},function(e){f(function(){y.sendState="error",y.errorMessage=e.data?e.data.message:e.statusText})})},this.addRecipient=function(e,t){var n,s,i,o,a=/([\w\!\#$\%\&\'\*\+\-\/\=\?\^\`{\|\}\~]+\.)*[\w\!\#$\%\&\'\*\+\-\/\=\?\^\`{\|\}\~]+@((((([a-z0-9]{1}[a-z0-9\-]{0,62}[a-z0-9]{1})|[a-z])\.)+[a-z]{2,})|(\d{1,3}\.){3}\d{1,3}(\:\d{1,5})?)/i,r=this.message.editable[t];if(angular.isString(e)){for(o="",i=0;i<e.length;i++)(9==e.charCodeAt(i)||32==e.charCodeAt(i)||44==e.charCodeAt(i)||59==e.charCodeAt(i))&&a.test(o)&&r.indexOf(o)<0?(r.push(o),o=""):o+=e.charAt(i);return o&&r.indexOf(o)<0&&r.push(o),null}return e.$isList({expandable:!0})?angular.isDefined(e.refs)&&e.refs.length?_.forEach(e.refs,function(e){e.email.length&&r.indexOf(e.$shortFormat())<0&&r.push(e.$shortFormat())}):(s=b.$find(e.container,e.c_name)).$id().then(function(e){_.forEach(s.refs,function(e){e.email.length&&r.indexOf(e.$shortFormat())<0&&r.push(e.$shortFormat())})}):e.$isGroup({expandable:!0})?(n={toString:function(){return e.$shortFormat()},isExpandable:!0,members:[]},e.$members().then(function(e){n.members=e})):n=e.$shortFormat(),n||null},this.setFromIdentity=function(e){var t,n,s,i;if(e&&e.full)this.message.editable.from=e.full;else if(e&&e.length)return;s="html"==this.composeType?(t="<br />",n="<br ?/>[ \n]?","&nbsp;"):(n=t="\n"," "),i=e&&e.signature?t+t+"--"+s+t+e.signature:"",!_.find(this.identities,function(e,t){if(e.signature){e=new RegExp(n+n+"--"+s+n+e.signature.replace(/[-\[\]{}()*+?.,\\^$|#\s]/g,"\\$&"));if(0<=y.message.editable.text.search(e))return y.message.editable.text=y.message.editable.text.replace(e,i),!0}return!1})&&0<i.length&&(this.isNew()||"above"!=this.signaturePlacement?this.message.editable.text+=i:(e=this.message.editable.text.search(new RegExp(n+".+?:( ?"+n+'){2}(> |<blockquote type="cite")')),this.message.editable.text=0<=e?this.message.editable.text.slice(0,e)+i+this.message.editable.text.slice(e):i+this.message.editable.text))},this.identitySearch=function(e){var t=e||"";return _.filter(u.identities,function(e){return 0<=e.full.toLowerCase().indexOf(t.toLowerCase())})},this.expandGroup=function(e,t){var n,s=this.message.editable[t],i=s.indexOf(e);for(s.splice(i,1),n=0;n<e.members.length;n++){var o=e.members[n].$shortFormat();s.indexOf(o)<0&&s.splice(i+n,0,e.members[n].$shortFormat())}},this.isNew=function(){return void 0===this.message.origin},this.onTextFocus=function(e){var o=e.target;this.firstFocus&&(h().then(function(e){var t,n=angular.element(o).val(),s=/\n-- \n/.test(n),i=0;"above"==y.replyPlacement?(o.setCaretTo(0),e.find("md-dialog-content")[0].scrollTop=0):(s&&-1<(t=n.lastIndexOf("-- "))&&(i=n.length-t),e=n.length-i,i=t=e,-1<(n=n).indexOf("\r\n")&&(i-=(t=n.replace(/\r\n/g,"\n").slice(0,t).match(/\n/g))?t.length-1:0),e=i,s&&(e-=2),o.setCaretTo(e))}),this.firstFocus=!1)},this.onHTMLReady=function(e){this.isNew()||h().then(function(){e.focus()})},this.onHTMLFocus=function(r){this.firstFocus&&(h().then(function(e){var t,n="above"==y.replyPlacement,s=r.getSelection(),i=s.getRanges(),o=r.document.getBody().getChildren();if(n)t=o.getItem(0);else for(t=o.getItem(o.count()-1);;){var a=t.getPrevious();if(null===a)break;if(/--(%20|%A0|%C2%A0)/.test(encodeURI(a.getText()))){t=a.getPrevious().getPrevious();break}t=a}s.selectElement(t),n&&s.scrollIntoView(),(i=s.getRanges())[0].collapse(!0),s.selectRanges(i),n||s.scrollIntoView()}),this.firstFocus=!1)}}function t(e,t){e.closeToast=function(){t.hide()}}e.$inject=["$scope","$window","$stateParams","$mdConstant","$mdUtil","$mdDialog","$mdToast","FileUploader","stateParent","stateAccount","stateMessage","onCompletePromise","encodeUriFilter","$timeout","sgFocus","Dialog","AddressBook","Card","Preferences"],t.$inject=["$scope","$mdToast"],angular.module("SOGo.MailerUI").controller("SendMessageToastController",t).controller("MessageEditorController",e)}(),function(){function e(e,t,n,s,i,o,a,r){var l=[];this.$postLink=function(){this.quotaElement=_.find(e.find("div"),function(e){return e.classList.contains("sg-quota")})},this.addMailboxController=function(e){l.push(e)},this.selectFolder=function(e){a.selectedFolderController=e,null===a.selectedFolder||(e=_.find(l,function(e){return e.mailbox.id==a.selectedFolder.id}))&&e.unselectFolder(),s(o["gt-md"])||i("left").close()}}e.$inject=["$element","$transitions","$state","$mdMedia","$mdSidenav","sgConstant","Mailbox","encodeUriFilter"],angular.module("SOGo.MailerUI").controller("sgAccountController",e).directive("sgAccountSection",function(){return{restrict:"C",scope:{},controller:"sgAccountController"}})}(),function(){"use strict";function e(n,t){var s=this;n.delegateInvitation=!1,n.delegatedTo="",n.searchText="",n.userFilter=function(e){return t.$filter(e)},n.iCalendarAction=function(e){var t;"delegate"==e&&(t={receiveUpdates:!1,delegatedTo:n.delegatedTo.c_email}),n.viewer.message.$imipAction(s.pathToAttachment,e,t)}}e.$inject=["$scope","User"],angular.module("SOGo.MailerUI").controller("sgImipController",e).directive("sgImip",function(){return{restrict:"A",link:function(e,t,n,s){s.pathToAttachment=n.sgImipPath},controller:"sgImipController"}})}(),function(){function e(e,t,n,s,o,i,a,r,c,u,d,h){var g=this;this.$onInit=function(){this.$element=t,this.editMode=!1,this.accountController.addMailboxController(this)},this.$postLink=function(){this.selectableElement=t.find("div")[0],this.clickableElement=t.find("p")[0],this.inputContainer=t.find("md-input-container")[0],this.inputElement=t.find("input")[0],this.moreOptionsButton=_.last(t.find("md-icon")),null!==d.selectedFolder&&d.selectedFolder.id==this.mailbox.id&&this.accountController.selectFolder(this)},this.childLevel=function(){return"sg-child-level-"+this.mailbox.level},this.selectFolder=function(e){this.editMode||this.mailbox==d.selectedFolder||this.mailbox.isNoSelect()||(d.$virtualPath=!1,d.$virtualMode=!1,this.accountController.selectFolder(this),e&&(n.go("mail.account.mailbox",{accountId:this.mailbox.$account.id,mailboxId:h(h(this.mailbox.path))}),e.stopPropagation(),e.preventDefault()))},this.unselectFolder=function(){t[0].classList.remove("md-bg")},this.editFolder=function(e){e.stopPropagation(),e.preventDefault(),this.editMode=!0,this.inputElement.value=this.mailbox.name,this.clickableElement.classList.add("ng-hide"),this.inputContainer.classList.remove("ng-hide"),e.srcEvent&&"touchend"==e.srcEvent.type?s(function(){g.inputElement.select(),g.inputElement.focus()},200):(this.inputElement.select(),this.inputElement.focus()),this.panel&&this.panel.close()},this.saveFolder=function(e){this.inputElement.disabled||(this.mailbox.name=this.inputElement.value,this.inputElement.disabled=!0,this.mailbox.$rename().then(function(e){g.editMode=!1,g.inputContainer.classList.add("ng-hide"),g.clickableElement.classList.remove("ng-hide")}).finally(function(){g.inputElement.disabled=!1}))},this.revertEditing=function(){this.editMode=!1,this.clickableElement.classList.remove("ng-hide"),this.inputContainer.classList.add("ng-hide"),this.inputElement.value=this.mailbox.name},this.confirmDelete=function(){u.confirm(l("Warning"),l("Do you really want to move this folder into the trash ?"),{ok:l("Delete")}).then(function(){g.mailbox.$delete().then(function(){n.go("mail.account.inbox")},function(e){u.confirm(l("Warning"),l("The mailbox could not be moved to the trash folder. Would you like to delete it immediately?"),{ok:l("Delete")}).then(function(){g.mailbox.$delete({withoutTrash:!0}).then(function(){n.go("mail.account.inbox")},function(e){u.alert(l('An error occured while deleting the mailbox "%{0}".',g.mailbox.name),l(e.error))})})})})},this.showMenu=function(e){var t=i.newPanelPosition().relativeTo(this.moreOptionsButton).addPanelPosition(i.xPosition.ALIGN_START,i.yPosition.ALIGN_TOPS),n=i.newPanelAnimation().openFrom(this.moreOptionsButton).duration(100).withAnimation(i.animation.FADE),e={attachTo:angular.element(document.body),locals:{itemCtrl:this,folder:this.mailbox,editFolder:angular.bind(this,this.editFolder),confirmDelete:angular.bind(this,this.confirmDelete)},bindToController:!0,controller:s,controllerAs:"$menuCtrl",position:t,animation:n,targetEvent:e,templateUrl:"UIxMailFolderMenu",trapFocus:!0,clickOutsideToClose:!0,escapeToClose:!0,focusOnOpen:!0};function s(t,e,n,s){var i=this;this.markFolderRead=function(){this.folder.$markAsRead()},this.newFolder=function(){u.prompt(l("New Folder..."),l("Enter the new name of your folder")).then(function(n){i.folder.$newMailbox(i.folder.id,n).then(function(){},function(e,t){u.alert(l('An error occured while creating the mailbox "%{0}".',n),l(e.error))})})},this.compactFolder=function(){this.folder.$compact().then(function(){o.show(o.simple().textContent(l("Folder compacted")).position("top right").hideDelay(3e3))})},this.emptyTrashFolder=function(){this.folder.$emptyTrash().then(function(){o.show(o.simple().textContent(l("Trash emptied")).position("top right").hideDelay(3e3))})},this.showAdvancedSearch=function(){d.$virtualPath=this.folder.path,a(c["gt-md"])||r("left").close()},this.share=function(){var e=angular.bind(this.folder.constructor.$$resource,this.folder.constructor.$$resource.encodeURL);this.folder.$acl.$users().then(function(){n.show({templateUrl:e(i.folder.id).join("/")+"/UIxAclEditor",controller:"AclController",controllerAs:"acl",clickOutsideToClose:!0,escapeToClose:!0,locals:{usersWithACL:i.folder.$acl.users,User:s,folder:i.folder}})})},this.setFolderAs=function(e){this.folder.$setFolderAs(e).then(function(){i.folder.$account.$getMailboxes({reload:!0})})},this.isParentOf=function(s){var i=function(e){if(!(e.children&&0<e.children.length))return e.path==s;for(var t=0;t<e.children.length;t++){var n=e.children[t];if(n.children&&0<n.children.length){if(i(n))return!0}else if(n.path==s)return!0}};return i(this.folder)},this.moveFolder=function(e){this.folder.$move(e),t.close()}}i.open(e).then(function(e){(g.panel=e).panelEl.one("click",function(){e.close()})}),s.$inject=["mdPanelRef","$state","$mdDialog","User"]}}e.$inject=["$scope","$element","$state","$timeout","$mdToast","$mdPanel","$mdMedia","$mdSidenav","sgConstant","Dialog","Mailbox","encodeUriFilter"],angular.module("SOGo.MailerUI").controller("sgMailboxListItemController",e).directive("sgMailboxListItem",function(){return{restrict:"C",require:{accountController:"^^sgAccountSection"},scope:{},bindToController:{mailbox:"=sgMailbox"},template:['  <div class="sg-child-level-0"','       ng-class="$ctrl.childLevel()">','    <md-checkbox class="sg-folder"','                 ng-class="$ctrl.mailbox.$icon"','                 aria-label="'+l("Expanded")+'"','                 ng-model="$ctrl.mailbox.$expanded"','                 ng-disabled="$ctrl.mailbox.children.length == 0"','                 ng-change="$ctrl.mailbox.$account.$flattenMailboxes({ reload: true, saveState: true })">',"    </md-checkbox>","  </div>",'  <p class="sg-item-name"','    ng-click="$ctrl.selectFolder($event)"','    ng-dblclick="$ctrl.editFolder($event)">',"    <md-icon ng-class=\"{ 'sg-opacity-70': $ctrl.mailbox.isNoSelect() }\">{{$ctrl.mailbox.$icon}}</md-icon>",'    <span ng-bind="$ctrl.mailbox.$displayName"></span>','    <span class="sg-counter-badge ng-hide"','          ng-show="$ctrl.mailbox.unseenCount"','          ng-bind="$ctrl.mailbox.unseenCount"></span>',"  </p>",'  <md-input-container class="md-flex ng-hide">','    <input class="sg-item-name" type="text"','           aria-label="'+l("Enter the new name of your folder")+'"','           ng-blur="$ctrl.saveFolder($event)"','           sg-enter="$ctrl.saveFolder($event)"','           sg-escape="$ctrl.revertEditing()" />',"  </md-input-container>",'  <md-icon class="md-menu md-secondary-container" ng-click="$ctrl.showMenu($event)" aria-label="'+l("Options")+'">more_vert</md-icon>'].join(""),controller:"sgMailboxListItemController",controllerAs:"$ctrl"}})}(),function(){function e(t,e,n){var s=this;this.$onInit=function(){var e=["uid","isread","isflagged","flags","subject"];"draft"==(this.MailboxService=n).selectedFolder.type&&e.push("subject"),t.$watch(function(){return s.message?[_.pick(s.message,e)]:null},function(e,t){s.message&&s.onUpdate()},!0)},this.onUpdate=function(){this.message.isread?e.removeClass("unread"):e.addClass("unread"),n.selectedFolder.isSelectedMessage(this.message.uid,this.message.$mailbox.path)?e.addClass("md-default-theme md-accent md-bg md-hue-2"):e.removeClass("md-default-theme md-accent md-bg md-hue-2")},this.setVisibility=function(e,t){t?e.classList.remove("ng-hide"):e.classList.add("ng-hide")}}e.$inject=["$scope","$element","Mailbox"],angular.module("SOGo.MailerUI").controller("sgMessageListItemController",e).directive("sgMessageListItem",function(){return{restrict:"C",scope:{},bindToController:{message:"=sgMessage"},controller:"sgMessageListItemController"}})}(),function(){function e(s,l,e,t,c,n,i,o,a){var u=this;this.$postLink=function(){var t,e,n,a,r;this.parentController=s.parentController,a=this.parentController.onUpdate,r=this.parentController.setVisibility,_.forEach(l.find("div"),function(e){e.classList.contains("sg-tile-content")?t=angular.element(e):e.classList.contains("sg-tile-icons")&&(n=angular.element(e))}),e=t.find("button")[0],this.threadButton=e,e=angular.element(e),this.threadIconElement=e.find("md-icon")[0],this.threadCountElement=e.find("span")[0],this.priorityIconElement=t.find("md-icon")[0],i.$virtualMode&&(this.mailboxNameElement=t.find("span")[0],this.mailboxNameElement.classList.remove("ng-hide")),this.senderElement=t.find("span")[1],_.forEach(t.find("div"),function(e){e.classList.contains("sg-tile-subject")?u.subjectElement=e:e.classList.contains("sg-tile-size")?u.sizeElement=e:e.classList.contains("sg-tile-date")&&(u.dateElement=e)}),_.forEach(n.find("md-icon"),function(e){"star"==e.textContent?u.flagIconElement=e:"reply"==e.textContent?u.answerIconElement=e:"forward"==e.textContent?u.forwardIconElement=e:"attach_file"==e.textContent&&(u.attachmentIconElement=e)}),this.parentController.onUpdate=function(){var e;u.message=u.parentController.message;var t=l[0].querySelector(".sg-category-dot-container"),n=angular.element(t),s=c.nodesToArray(t.querySelectorAll(".sg-category-dot"));for(_.forEach(s,function(e){t.removeChild(e)}),e=0;e<u.message.flags.length&&e<5;e++){var i,o=u.message.flags[e];u.service.$tags[o]&&((i=angular.element('<div class="sg-category-dot"></div>')).css("background-color",u.service.$tags[o][1]),n.append(i))}u.mailboxNameElement&&(u.mailboxNameElement.innerHTML=u.message.$mailbox.$displayName),u.MailboxService.selectedFolder.isSentFolder?u.senderElement.innerHTML=u.message.$shortAddress("to").encodeEntities():u.senderElement.innerHTML=u.message.$shortAddress("from").encodeEntities(),u.message.priority&&u.message.priority.level<3?(u.priorityIconElement.classList.remove("ng-hide"),u.message.priority.level<2?u.priorityIconElement.classList.add("md-warn"):u.priorityIconElement.classList.remove("md-warn")):u.priorityIconElement.classList.add("ng-hide"),u.message.first?(u.threadButton.classList.remove("ng-hide"),u.threadCountElement.innerHTML=u.message.threadCount,u.message.collapsed&&u.threadIconElement.classList.remove("md-rotate-180-ccw")):u.threadButton.classList.add("ng-hide"),u.subjectElement.innerHTML=u.message.subject.encodeEntities(),u.sizeElement.innerHTML=u.message.size,u.dateElement.innerHTML=u.message.relativedate,r(u.flagIconElement,u.message.isflagged),r(u.answerIconElement,u.message.isanswered),r(u.forwardIconElement,u.message.isforwarded),r(u.attachmentIconElement,u.message.hasattachment),angular.bind(u.parentController,a)()},this.service=o,this.MailboxService=i},this.toggleThread=function(){this.message.collapsed?this.threadIconElement.classList.add("md-rotate-180-ccw"):this.threadIconElement.classList.remove("md-rotate-180-ccw"),this.message.toggleThread()}}e.$inject=["$scope","$element","$parse","$state","$mdUtil","$mdToast","Mailbox","Message","encodeUriFilter"],angular.module("SOGo.MailerUI").controller("sgMessageListItemMainController",e).directive("sgMessageListItemMain",function(){return{restrict:"C",require:"^^sgMessageListItem",scope:{},template:['<div class="sg-tile-content">','  <div class="sg-md-subhead">',"    <div>",'      <span class="sg-label-outline ng-hide">\x3c!-- mailbox --\x3e</span>','      <md-icon class="ng-hide">error</md-icon>',"      <span>\x3c!-- sender or recipient --\x3e</span>","    </div>",'    <div class="sg-tile-date">\x3c!-- date --\x3e</div>',"  </div>",'  <div class="sg-md-body">','    <div class="sg-category-dot-container">\x3c!-- categories --\x3e</div>','    <div class="sg-tile-subject">\x3c!-- subject --\x3e</div>','    <div class="sg-tile-size">\x3c!-- size --\x3e</div>','    <md-button class="sg-tile-btn md-secondary ng-hide" md-colors="::{ color: \'accent-600\'}" ng-click="$ctrl.toggleThread()">','      <md-icon class="md-rotate-180-ccw" md-colors="::{ color: \'accent-600\'}">expand_more</md-icon><span></span>',"    </md-button>","  </div>","</div>",'<div class="sg-tile-icons">','  <md-icon class="ng-hide sg-icon-star">star</md-icon>','  <md-icon class="ng-hide">reply</md-icon>','  <md-icon class="ng-hide">forward</md-icon>','  <md-icon class="ng-hide">attach_file</md-icon>',"</div>",'<div class="sg-progress-linear-bottom">','  <md-progress-linear class="md-accent"','                      md-mode="indeterminate"','                      ng-disabled="!$ctrl.message.$isLoading()">\x3c!-- message loading progress --\x3e</md-progress-linear>',"</div>"].join(""),link:function(e,t,n,s){e.parentController=s},controller:"sgMessageListItemMainController",controllerAs:"$ctrl"}})}(),function(){"use strict";function e(e,t){var n=this;this.$postLink=function(){t.registerImage(e),e.on("click",this.showImage)},this.showImage=function(e){"IMG"==e.target.tagName&&t.showGallery(e,n.partIndex)}}e.$inject=["$element","ImageGallery"],angular.module("SOGo.MailerUI").directive("sgZoomableImage",function(){return{restrict:"A",bindToController:{partIndex:"=sgZoomableImage"},controller:e}})}();
//# sourceMappingURL=Mailer.services.js.map